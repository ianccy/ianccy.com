{"componentChunkName":"component---src-templates-post-tsx","path":"/nextupdate/","result":{"data":{"site":{"siteMetadata":{"title":"Ian Chu"}},"markdownRemark":{"id":"bea1de82-0185-566a-a458-8c96d5f2904d","excerpt":"前陣子公司專案從 next 3 更新到 7、react 也從 15 更新到 16，希望能加快開發或佈署的速度，順便分享一下踩到了哪些的地雷。 首先呢，update react、react-dom、next，接下來開始測試一下 local build…","html":"<p>前陣子公司專案從 next 3 更新到 7、react 也從 15 更新到 16，希望能加快開發或佈署的速度，順便分享一下踩到了哪些的地雷。</p>\n<p>首先呢，update react、react-dom、next，接下來開始測試一下 local build，執行 <code class=\"language-text\">yarn build</code>，恩…，大概幾隻套件過舊，完全無法編譯，幸好這幾隻套件都有繼續維運，更新一下套件，重新繼續 yarn build => yarn start。</p>\n<h2 id=\"產生-build_id\" style=\"position:relative;\"><a href=\"#%E7%94%A2%E7%94%9F-build_id\" aria-label=\"產生 build_id permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>產生 BUILD_ID</h2>\n<p>發現 run 起來會抓不到 app.js，發現需要處理路徑問題，舊版 next build 出來的目錄，不會帶有 BUILD_ID，只會在編譯的時候，拿取.next 的 BUILD_ID 來當作路徑，之前是利用 docker 產生.BUILD_ID。但是新版的會直接寫在 folder name 上。要使用 generateBuildId 產生 buildId，對了，我們 buildId 內容是 git commit hash。</p>\n<p><a href=\"https://nextjs.org/docs/#configuring-the-build-id\" title=\"generateBuildId\">next.js generateBuildId </a></p>\n<p>另外還有 react 更新，所以 eslint 相關插件也要更新到新版，花了<code class=\"language-text\">一些</code>(三天)時間再處理 indent 跟一些新版的 eslint rule。</p>\n<p>其餘並沒有改動太大，next.js 拋棄滿多舊有 router 處理，把專案上有用到部分都移除掉，還有 title tag 不在_document.js render。</p>\n<h2 id=\"踩坑\" style=\"position:relative;\"><a href=\"#%E8%B8%A9%E5%9D%91\" aria-label=\"踩坑 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>踩坑</h2>\n<p>心裡想更新 react、next 還真是簡單，於是乎信心滿滿的更新到正式機上，但是，才發現事情沒有我想的這麼簡單。</p>\n<p>當天晚上發現各種 error、bug 相繼發生，因為更新幅度非常大，需要花滿多時間判斷問題發生在哪個部分。</p>\n<h2 id=\"nextjs-router-bug\" style=\"position:relative;\"><a href=\"#nextjs-router-bug\" aria-label=\"nextjs router bug permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>next.js router bug</h2>\n<p>發現一個非常嚴重的問題，Safari 點選網頁上的連結到外部網站，在返回頁面回來，next 會直接導引到 error page。\n( 到我發文這天都沒修復掉，持續有人回報。 )</p>\n<p><a href=\"https://github.com/zeit/next.js/issues/4103\" title=\"next.js safari bug \">next.js safari bug </a></p>\n<p>next.js 有個用法，建立_app.js，當作各個 pages/yourpath.js 共用的 render point，我在這邊處理不同路徑共用 title tag，_app.js 需要依靠 pages/path.js 傳入資料，我就使用了 getInitialProps 來處理 server side call api 取得的資料。</p>\n<p>但是問題發生在 Safari 返回頁面，會使用之前的 cache，並且不對 server 做請求，返回頁面會執行 getInitialProps 但是取不到 server side 拿到的資料，所以資料會錯誤，導致錯誤發生。</p>\n<p>目前看起來問題還在，這邊修復方法是，直接拉掉 getInitialProps 取 server side 資料，改到內層去 render title。</p>\n<h2 id=\"react-serverclient-side-html-不同步\" style=\"position:relative;\"><a href=\"#react-serverclient-side-html-%E4%B8%8D%E5%90%8C%E6%AD%A5\" aria-label=\"react serverclient side html 不同步 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>react server、client side HTML 不同步</h2>\n<p>這是 react 16 再處理 server side 到 client side render 畫面的邏輯修改，為了增加 render 效能，react 拋棄的比對 server side to client html 比對，官方建議 server side 跟 client side 的 html 要盡量保持一致。如果要有不一樣的話，建議在 componentDidMount setState 處理畫面更新。</p>\n<p>發現部分的 html 畫卡在 server side render layout，修復方法就利用 server side 跟 client side 用不同的 key 值，讓 react 比對 node 做更新。但是如果要更新 dangerouslySetInnerHTML 用 key 方法也沒用，目前 hotfix 作法是兩邊用不同的 html tag 強更新，之後會改為 componentDisMount 更新。</p>\n<h3 id=\"react-16-官方宣告\" style=\"position:relative;\"><a href=\"#react-16-%E5%AE%98%E6%96%B9%E5%AE%A3%E5%91%8A\" aria-label=\"react 16 官方宣告 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>react 16 官方宣告</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">In general<span class=\"token punctuation\">,</span> we don’t recommend that you render different content on the client versus the server<span class=\"token punctuation\">,</span> but it can be useful <span class=\"token keyword\">in</span> some <span class=\"token function\">cases</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>g<span class=\"token punctuation\">.</span> timestamps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>\nHowever<span class=\"token punctuation\">,</span> it’s dangerous to have missing nodes on the server render <span class=\"token keyword\">as</span> <span class=\"token keyword\">this</span> might cause sibling nodes to be created <span class=\"token keyword\">with</span> incorrect attributes<span class=\"token punctuation\">.</span></code></pre></div>\n<p><a href=\"https://reactjs.org/blog/2017/09/26/react-v16.0.html#better-server-side-rendering\" title=\"Better server-side rendering \">Better server-side rendering </a></p>\n<h2 id=\"心得\" style=\"position:relative;\"><a href=\"#%E5%BF%83%E5%BE%97\" aria-label=\"心得 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>心得</h2>\n<p>更新大概花了 2 週左右時間，大部分時間都在調整 next config，原先更新是為了使用 react 16 新語法，還有希望能加速專案 build deploy 的速度。結果 next 這部分是有稍快一點，但 主要優點還是在於 react 語法，方便我們在開發上處理更多問題，還有跟上 react 更新腳步，未來希望能夠導入 react hooks。</p>\n<p>很多狀況在測試階段都沒有察覺，不幸的 release 後發現很多問題…，幸好都有找到原因修復掉。</p>\n<!--- ![node.js](../images/next&react.png \"next & react\") --->\n","fields":{"readingTime":{"text":"5 min read"}},"frontmatter":{"title":"Update Next.js 7、react 16 error and bug","date":"December 09, 2018","description":"前陣子公司專案從next3更新到7、react也從15更新到16，希望能加快開發或佈署的速度，順便分享一下踩到了哪些的地雷。","categories":"javascript","tags":["react.js"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/7b99da12437122f2dbf8e8ce89c73dc8/ac78e/next%26react.png","srcSet":"/static/7b99da12437122f2dbf8e8ce89c73dc8/bcdba/next%26react.png 200w,\n/static/7b99da12437122f2dbf8e8ce89c73dc8/08292/next%26react.png 400w,\n/static/7b99da12437122f2dbf8e8ce89c73dc8/ac78e/next%26react.png 800w","sizes":"(min-width: 800px) 800px, 100vw"},"sources":[{"srcSet":"/static/7b99da12437122f2dbf8e8ce89c73dc8/8a265/next%26react.webp 200w,\n/static/7b99da12437122f2dbf8e8ce89c73dc8/268cf/next%26react.webp 400w,\n/static/7b99da12437122f2dbf8e8ce89c73dc8/2d836/next%26react.webp 800w","type":"image/webp","sizes":"(min-width: 800px) 800px, 100vw"}]},"width":1280,"height":627.1999999999999}}},"image":{"publicURL":"/static/7b99da12437122f2dbf8e8ce89c73dc8/next&react.png"}},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E7%94%A2%E7%94%9F-build_id\">產生 BUILD_ID</a></p>\n</li>\n<li>\n<p><a href=\"#%E8%B8%A9%E5%9D%91\">踩坑</a></p>\n</li>\n<li>\n<p><a href=\"#nextjs-router-bug\">next.js router bug</a></p>\n</li>\n<li>\n<p><a href=\"#react-serverclient-side-html-%E4%B8%8D%E5%90%8C%E6%AD%A5\">react server、client side HTML 不同步</a></p>\n<ul>\n<li><a href=\"#react-16-%E5%AE%98%E6%96%B9%E5%AE%A3%E5%91%8A\">react 16 官方宣告</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E5%BF%83%E5%BE%97\">心得</a></p>\n</li>\n</ul>"},"previous":{"fields":{"slug":"/2018-12-seoredirect/"},"frontmatter":{"title":"SEO 301、302轉址Redirect，canonical tag重複內容處理"}},"next":{"fields":{"slug":"/2018-11-structuredseo/"},"frontmatter":{"title":"結構化資料SEO 優化顯示搜尋結果"}}},"pageContext":{"id":"bea1de82-0185-566a-a458-8c96d5f2904d","previousPostId":"9aaae7ce-759a-5217-9751-db71aa15ffe4","nextPostId":"de71c8b3-9e85-565e-8766-9f3ae4cdc2b8"}},"staticQueryHashes":["3649515864","3707347541","3761976949"],"slicesMap":{}}