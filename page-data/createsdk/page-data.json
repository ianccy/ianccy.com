{"componentChunkName":"component---src-templates-post-tsx","path":"/createsdk/","result":{"data":{"site":{"siteMetadata":{"title":"Ian Chu"}},"markdownRemark":{"id":"ccfd436b-a7ca-58ad-91a7-f71f02cc1d9c","excerpt":"去年在公司做了一個滿好玩的專案，要建立一個 JavaScript tracking sdk，透過客戶的 google tag manager 安裝，收集客戶的 user 使用資料，能做到部署 code 後，每個客戶都自動更新成最新的版本，額外要做到版本控制，讓部分客戶選擇安裝舊版的 tracking sdk…","html":"<p>去年在公司做了一個滿好玩的專案，要建立一個 JavaScript tracking sdk，透過客戶的 google tag manager 安裝，收集客戶的 user 使用資料，能做到部署 code 後，每個客戶都自動更新成最新的版本，額外要做到版本控制，讓部分客戶選擇安裝舊版的 tracking sdk，uglify code 不讓邏輯被輕易了解，至於後面業務細節就不提太多了。</p>\n<p>後面會分享 JavaScript sdk 我是如何規劃、建立這個專案的，然後在把整個想法實作出來。</p>\n<h2 id=\"planning\" style=\"position:relative;\"><a href=\"#planning\" aria-label=\"planning permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Planning</h2>\n<p>先從最基本的 coding tool 來想，現況前端都會要求程式碼要有型別，日後維運會方便很多，所以要有 TypeScript，再來是 bundler，打包程式碼並且 minify 加上 uglify，能減少 code file size，不要讓 code 業務邏輯輕易被看光，這邊我選用 rollup，理由是搭配 typescript setup 容易，有 tree shaking 來減低打包檔案大小，提供的 plugin 也足夠使用。</p>\n<p>再來就是 deploy 要 deploy 到哪裡，這邊選擇相對多，可以是 s3、gcs 或是 github hosting，公司專案我是選用 gcs，因為專案都是用 google cloud 的，另外用 cloud storage 還可以額外 setup meta header。</p>\n<p>還有 CI/CD 要能自動化 deploy，避免手動作業流程，再來還有 javascript 搭配 cdn，提高我們 file 被載入的速度，順便還可以處理 custom domain。</p>\n<p>也要有清除 cdn cache 的機制，當更新版本後，能讓客戶快速取得最新版本的 file。</p>\n<p>所以這邊我需要有 bundler、build version control、CI/CD deploy、hosting javascript file、CDN setup。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin: 2vw 0;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1980px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/111dea7607a2b937429cba3e2a6f9b30/d8012/createlibrary-flow.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.07070707070707%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAOklEQVR42j2LwQ4AIAhC+/9PbWtuKlonMw4dGOMBw5BlsUvb1YPuP4OdqFMWr2veDHm4mUtKDOW5+bs3Uk0x8p8ZCwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/111dea7607a2b937429cba3e2a6f9b30/a805d/createlibrary-flow.webp 495w,\n/static/111dea7607a2b937429cba3e2a6f9b30/36741/createlibrary-flow.webp 990w,\n/static/111dea7607a2b937429cba3e2a6f9b30/41a9f/createlibrary-flow.webp 1980w,\n/static/111dea7607a2b937429cba3e2a6f9b30/b8d13/createlibrary-flow.webp 2258w\"\n              sizes=\"(max-width: 1980px) 100vw, 1980px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/111dea7607a2b937429cba3e2a6f9b30/b3db0/createlibrary-flow.png 495w,\n/static/111dea7607a2b937429cba3e2a6f9b30/8ddfd/createlibrary-flow.png 990w,\n/static/111dea7607a2b937429cba3e2a6f9b30/7c078/createlibrary-flow.png 1980w,\n/static/111dea7607a2b937429cba3e2a6f9b30/d8012/createlibrary-flow.png 2258w\"\n            sizes=\"(max-width: 1980px) 100vw, 1980px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/111dea7607a2b937429cba3e2a6f9b30/7c078/createlibrary-flow.png\"\n            alt=\"createlibrary flow\"\n            title=\"createlibrary flow\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">createlibrary flow</figcaption>\n  </figure></p>\n<h2 id=\"develop-setup\" style=\"position:relative;\"><a href=\"#develop-setup\" aria-label=\"develop setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Develop Setup</h2>\n<p>這邊就不寫上介紹，直接列出步驟，主要都是設定 project 的工具，從最基本的 eslint、prettier、husky、jest、typescript 這些，可以直接看我的 sample project 是怎樣設定的</p>\n<ul>\n<li>Basic setup project (install develop environment)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">mkdir create<span class=\"token operator\">-</span>javaScript<span class=\"token operator\">-</span>sdk\ncd create<span class=\"token operator\">-</span>javaScript<span class=\"token operator\">-</span>sdk\nnpm init\n\n<span class=\"token comment\">// setup eslint. select env browser, npm and typescript</span>\nnpm init @eslint<span class=\"token operator\">/</span>config\n\n<span class=\"token comment\">// install lint-staged</span>\nnpm install <span class=\"token operator\">-</span><span class=\"token constant\">D</span> prettier lint<span class=\"token operator\">-</span>staged jest\n\n<span class=\"token comment\">// install husky</span>\nnpx husky init\n\n<span class=\"token comment\">// install rollup typescript</span>\nnpm install <span class=\"token operator\">-</span><span class=\"token constant\">D</span> typescript\n\n<span class=\"token comment\">// init typescript config</span>\nnpx tsc <span class=\"token operator\">--</span>init\n\n<span class=\"token comment\">// install jest</span>\nnpm install <span class=\"token operator\">-</span><span class=\"token constant\">D</span> jest\nnpm init jest@latest\nnpm install <span class=\"token operator\">-</span><span class=\"token constant\">D</span> babel<span class=\"token operator\">-</span>jest @babel<span class=\"token operator\">/</span>core @babel<span class=\"token operator\">/</span>preset<span class=\"token operator\">-</span>env @babel<span class=\"token operator\">/</span>preset<span class=\"token operator\">-</span>typescript @jest<span class=\"token operator\">/</span>globals ts<span class=\"token operator\">-</span>jest jest<span class=\"token operator\">-</span>environment<span class=\"token operator\">-</span>jsdom ts<span class=\"token operator\">-</span>node</code></pre></div>\n<p>其餘設定 husky (.husky/pre-commit)、jest 跟 prettier 的 config，再麻煩幫我看 git repo 了，篇幅真的有點太長，我不想花太多篇幅在寫設定專案。官方插件都查得到教學，工具依序是 typescript、eslint、prettier、babel、lint-staged、husky、jest。比較不一樣會有個人化的會是 linter、prettier，在各自修改自己喜歡的 coding style。</p>\n<p>改完之後可以 npm lint-staged 看看能不能正常跑 linter，通常都會卡在 jest 處理不了 typescript，解法就是 jest transform 要設定 <code class=\"language-text\">'^.+\\\\.ts?$': 'ts-jest'</code>。建議直接 clone 下面 sample repo 比較快XDD，我整個手動一個一個安裝，跑完加上 debug 也花了一點時間，另外如果我 repo 上的插件太舊再記得 <code class=\"language-text\">npm update</code>。</p>\n<p><a href=\"https://github.com/ianccy/create-javascript-sdk/tree/chore/setup-develop\" title=\"github setup sample\">Github Repo sample</a></p>\n<h2 id=\"bundle-setup\" style=\"position:relative;\"><a href=\"#bundle-setup\" aria-label=\"bundle setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Bundle Setup</h2>\n<p>這邊我們是選用 rollup，因為實際 build 出來的 file size 遠比 webpack 還小很多，開發 plugin 也足夠讓我們使用。</p>\n<ul>\n<li>install bundler rollup</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// install rollup</span>\nnpm install <span class=\"token operator\">-</span><span class=\"token constant\">D</span> rollup rollup<span class=\"token operator\">-</span>plugin<span class=\"token operator\">-</span>typescript2 @rollup<span class=\"token operator\">/</span>plugin<span class=\"token operator\">-</span>node<span class=\"token operator\">-</span>resolve @rollup<span class=\"token operator\">/</span>plugin<span class=\"token operator\">-</span>commonjs @rollup<span class=\"token operator\">/</span>plugin<span class=\"token operator\">-</span>babel @rollup<span class=\"token operator\">/</span>plugin<span class=\"token operator\">-</span>terser rollup<span class=\"token operator\">-</span>plugin<span class=\"token operator\">-</span>version<span class=\"token operator\">-</span>injector</code></pre></div>\n<ul>\n<li>Add script on package.json</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token literal-property property\">script</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token string-property property\">\"build-dev\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rollup -c -w\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string-property property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rollup -c --prod\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>我在設定卡了滿久的時間，大概 1、2 小時，不知道怎設定 rollup config 讓他吃到 config.ts，就算強制用 <code class=\"language-text\">rollup --config rollup.config.ts --configPlugin @rollup/plugin-typescript</code> 反而會卡在 tsconfig 各種沒有 apply 到…，索性直接把 file type 改成 mjs，rollup 就會自己 apply 到了。</p>\n<p>網路上也滿多人也在 rollup version 4 上遇到一樣問題，也沒看到什麼很好的解法。</p>\n<p>Error: <code class=\"language-text\">[!] TypeError: Unknown file extension \".ts\" for /Users/ian/Documents/create-javaScript-sdk/rollup.config.ts</code></p>\n<p>強烈建議大家要用 <code class=\"language-text\">format: iife</code>，這是實際踩過的血淚經驗，iife 是立即函示的意思，這代表會讓我們作用域封裝起來，確保我們在這個 sdk 內用得的變數都是內部變數，而不會被外部所覆蓋污染。因為 bundle 後，變數、function name 都會被 uglify 變成 a, b, c，這就很容易跟其他人的 bundle file 衝突到。</p>\n<p><code class=\"language-text\">rollup-plugin-version-injector</code> 則是幫我們把 version inject 到 file 上，方便我們檢查檔案的版本，<code class=\"language-text\">@rollup/plugin-terser</code> 則是 minify code 減少 file size。</p>\n<p>都完成之後就可以嘗試 <code class=\"language-text\">npm run build</code> 來檢查是否有建立 file 到 dist folder 內。</p>\n<ul>\n<li>create rollup.config.mjs</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> resolve <span class=\"token keyword\">from</span> <span class=\"token string\">'@rollup/plugin-node-resolve'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> commonjs <span class=\"token keyword\">from</span> <span class=\"token string\">'@rollup/plugin-commonjs'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> rollupTypescript <span class=\"token keyword\">from</span> <span class=\"token string\">'rollup-plugin-typescript2'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> babel <span class=\"token keyword\">from</span> <span class=\"token string\">'@rollup/plugin-babel'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> <span class=\"token constant\">DEFAULT_EXTENSIONS</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@babel/core'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> terser <span class=\"token keyword\">from</span> <span class=\"token string\">'@rollup/plugin-terser'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> versionInjector <span class=\"token keyword\">from</span> <span class=\"token string\">'rollup-plugin-version-injector'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> pkg <span class=\"token keyword\">from</span> <span class=\"token string\">'./package.json'</span> <span class=\"token keyword\">assert</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'json'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> folder <span class=\"token operator\">=</span> <span class=\"token string\">'./dist/'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">config</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">prod</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">input</span><span class=\"token operator\">:</span> <span class=\"token string\">'src/index.ts'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">output</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">file</span><span class=\"token operator\">:</span> folder <span class=\"token operator\">+</span> pkg<span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.js'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">-dev.js</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">format</span><span class=\"token operator\">:</span> <span class=\"token string\">'iife'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">strict</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token operator\">...</span><span class=\"token punctuation\">[</span>\n        prod <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token literal-property property\">file</span><span class=\"token operator\">:</span> folder <span class=\"token operator\">+</span> pkg<span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">,</span>\n          <span class=\"token literal-property property\">format</span><span class=\"token operator\">:</span> <span class=\"token string\">'iife'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token literal-property property\">strict</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        prod <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token literal-property property\">file</span><span class=\"token operator\">:</span> folder <span class=\"token operator\">+</span> pkg<span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.js'</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">-v</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>pkg<span class=\"token punctuation\">.</span>version<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.js</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          <span class=\"token literal-property property\">format</span><span class=\"token operator\">:</span> <span class=\"token string\">'iife'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token literal-property property\">strict</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">v</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> v<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">plugins</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">commonjs</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">rollupTypescript</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">babel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">exclude</span><span class=\"token operator\">:</span> <span class=\"token string\">'node_modules/**'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">extensions</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span><span class=\"token constant\">DEFAULT_EXTENSIONS</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'.ts'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">presets</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'@babel/preset-env'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">terser</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token function\">versionInjector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">args</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> prod <span class=\"token operator\">=</span> <span class=\"token operator\">!</span><span class=\"token operator\">!</span>args<span class=\"token punctuation\">.</span>prod<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">config</span><span class=\"token punctuation\">(</span>prod<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><a href=\"https://github.com/ianccy/create-javascript-sdk/tree/chore/rollup\" title=\"github setup rollup\">Github Repo rollup</a></p>\n<h2 id=\"cicd-setup\" style=\"position:relative;\"><a href=\"#cicd-setup\" aria-label=\"cicd setup permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CI/CD Setup</h2>\n<p>前面就大致上完成了開發環境的設定了，剩下其實都滿簡單的，我們再來是 CI/CD 的設定，我們就直接以 github action 來當範例好了，我們希望能在 push release tag 的時候去 build file，並且 upload 到 cloud storage，為了方便大家直觀這邊就直接用 github hosting js file。</p>\n<p>首先 create <code class=\"language-text\">.github/workflows/deploy.yml</code>，開始設定我們的 github action yaml，這邊就直接用 gh-pages 來 upload dist files 到另一個 github repo。</p>\n<p>package.json 也要在 script 加上 <code class=\"language-text\">deploy:ci: gh-pages -d dist -r https://$GH_TOKEN@github.com/ianccy/sample-javascript-sdk.git</code>。</p>\n<p>ps.記得到 github Setting 建立一個 secret token，然後設定到 repo 的 setting 上面。</p>\n<p>這邊我也卡了一下，原本我是想嘗試用 github action，不過多半都是專注在 upload assets 到指定的 repo，這跟我們需求差滿多的，我們也需要同時依賴 github hosting resource。</p>\n<ul>\n<li>deploy.yml</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">name: release the javascript sdk\n\non:\n  release:\n    types: [created]\n\nenv:\n  GH_TOKEN: ${{ secrets.GH_TOKEN }}\n\njobs:\n  release-code:\n    runs-on: ubuntu-latest\n    steps:\n      - name: GitHub Config\n        run: |\n          git config --global user.email \"chu2815@hotmail.com\"\n          git config --global user.name \"ianccy\"\n      - uses: actions/checkout@v2\n      - uses: actions/setup-node@v3\n        with:\n          node-version: 18\n          registry-url: https://registry.npmjs.org/\n      - name: Install dependencies\n        run: npm install\n      - name: Unit-Test\n        run: npm run test\n      - name: Build Code\n        run: npm run build\n      - name: Upload to GitHub Repository\n        run: npm run deploy:ci</code></pre></div>\n<ul>\n<li>add deploy:ci on package.json</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  script: {\n    ...\n    \"deploy:ci\": \"gh-pages -d dist -r https://$GH_TOKEN@github.com/ianccy/sample-javascript-sdk.git\"\n  }</code></pre></div>\n<h2 id=\"接下來設定-custom-domain\" style=\"position:relative;\"><a href=\"#%E6%8E%A5%E4%B8%8B%E4%BE%86%E8%A8%AD%E5%AE%9A-custom-domain\" aria-label=\"接下來設定 custom domain permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>接下來設定 custom domain</h2>\n<p>再來到 <code class=\"language-text\">sample-javascript-sdk</code> repo 去設定 custom domain，我是用 <code class=\"language-text\">js-sdk-sample.iannccy.com</code>，接下來到 cloudflare 去設定 dns 指向 github，幾乎就可以說是大功告成哩。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin: 2vw 0;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1980px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/75d7aac51cf68f604dbb2608879e2aae/d4e2e/createlibrary-cname.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 8.686868686868687%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAg0lEQVR42h2LWwuCQBhE/f9/S4kw1KRe1ALXzTJvezFX0HL6dh+GwxlmPKkN6leHdzdCTQbWR/kB408MQrtOqJm4oO0FSsbRtINz29uf/ShKVTfwYrbimE8Irj1ON4Mz/yEqV/jkYTEjIU+qjbgjvUuElwcOmabdFzHb6KsdU9oF2YI/XCyUFDxtapQAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/75d7aac51cf68f604dbb2608879e2aae/a805d/createlibrary-cname.webp 495w,\n/static/75d7aac51cf68f604dbb2608879e2aae/36741/createlibrary-cname.webp 990w,\n/static/75d7aac51cf68f604dbb2608879e2aae/41a9f/createlibrary-cname.webp 1980w,\n/static/75d7aac51cf68f604dbb2608879e2aae/58212/createlibrary-cname.webp 2306w\"\n              sizes=\"(max-width: 1980px) 100vw, 1980px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/75d7aac51cf68f604dbb2608879e2aae/b3db0/createlibrary-cname.png 495w,\n/static/75d7aac51cf68f604dbb2608879e2aae/8ddfd/createlibrary-cname.png 990w,\n/static/75d7aac51cf68f604dbb2608879e2aae/7c078/createlibrary-cname.png 1980w,\n/static/75d7aac51cf68f604dbb2608879e2aae/d4e2e/createlibrary-cname.png 2306w\"\n            sizes=\"(max-width: 1980px) 100vw, 1980px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/75d7aac51cf68f604dbb2608879e2aae/7c078/createlibrary-cname.png\"\n            alt=\"createlibrary cname\"\n            title=\"createlibrary cname\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">createlibrary cname</figcaption>\n  </figure></p>\n<p><a href=\"https://js-sdk-sample.ianccy.com/index.js\" title=\"JavaScript SDK\">JavaScript SDK</a></p>\n<p>再來補上 purge cache 在 CD flow，確保我們每一次部署上去的 file 都會 purge cdn cache，確保客戶可以盡快拿到最新版的 js file。</p>\n<p>同時需要設定對應的 secrets 到 github repo 上。\n<a href=\"https://github.com/marketplace/actions/cloudflare-purge-cache\" title=\"github action guide\">github action guide</a></p>\n<ul>\n<li>deploy.yml</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">      - name: Purge cache\n        uses: jakejarvis/cloudflare-purge-action@master\n        env:\n          CLOUDFLARE_ZONE: ${{ secrets.CLOUDFLARE_ZONE }}\n          CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}\n          CLOUDFLARE_EMAIL: ${{ secrets.CLOUDFLARE_EMAIL }}\n          CLOUDFLARE_KEY: ${{ secrets.CLOUDFLARE_KEY }}\n          PURGE_URLS: '[\"https://js-sdk-sample.ianccy.com/index.js\"]'</code></pre></div>\n<h2 id=\"push-tag-and-create-release-with-tag\" style=\"position:relative;\"><a href=\"#push-tag-and-create-release-with-tag\" aria-label=\"push tag and create release with tag permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Push Tag and Create Release with Tag</h2>\n<p>接下來就是 create tag ，再到 github repo 去建立 release，就會觸發 github action 執行 CI/CD 了。可以點開 action 來查看每個步驟是不是有正確執行完畢。</p>\n<p><a href=\"https://github.com/ianccy/create-javascript-sdk/actions/runs/7863309142\" title=\"github action result\">github action result</a></p>\n<p><a href=\"https://github.com/ianccy/create-javascript-sdk\" title=\"github repo\">github repo</a></p>\n<h2 id=\"心得\" style=\"position:relative;\"><a href=\"#%E5%BF%83%E5%BE%97\" aria-label=\"心得 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>心得</h2>\n<p>起初是想寫我怎樣規劃設計這整個架構，也包含怎儲存資料，但礙於一些 nda 因素，不方便講太多細節，再說我覺得每一個步驟怎實作也很重要，兩者相衡之下，就選擇介紹 setup 架構了。因為我當時在網路上找不到相關教學，每個步驟都是零散的拼湊出來的…，我當時大概花了 2~3 天規劃然後寫完，想拋磚引玉寫一篇 setup 的文章、sample repo。</p>\n<p>至於我是如何選擇工具，其實想法很簡單，費用成本 > 效能 > 維運，我是選擇用 gcs，可以讓我客製化 meta header 很方便，再來搭配 cloudflare cdn cache 幾乎沒什麼成本，不選擇 webpack 是因為效能差異太大了，真的是盡可能減少 file size。維運問題上，rollup 可能雷相對多一點點，社群相對小一點，但這就是取捨了，rollup 的優點遠大於缺點。</p>\n<p>整個來說設定 repo 開發環境跟 github cloudflare 之間連動比較麻煩。</p>\n<p>一樣有問題歡迎詢問，打錯的地方也歡迎更正我。</p>\n<p>最後 murmur 一下，最近都在學 python 還有後端，所以 blog 文章嚴重拖稿中…，待寫文章堆積如山。然後久久沒寫 blog 文筆超爛 QQ。</p>","fields":{"readingTime":{"text":"11 min read"}},"frontmatter":{"title":"How to create JavaScript web sdk","date":"February 11, 2024","description":null,"categories":"javascript","tags":["sdk","rollup"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#181818","images":{"fallback":{"src":"/static/4145ff3a80750cd01cb79e68371a4484/3e766/createlibrary.jpg","srcSet":"/static/4145ff3a80750cd01cb79e68371a4484/ef064/createlibrary.jpg 158w,\n/static/4145ff3a80750cd01cb79e68371a4484/7135c/createlibrary.jpg 316w,\n/static/4145ff3a80750cd01cb79e68371a4484/3e766/createlibrary.jpg 631w","sizes":"(min-width: 631px) 631px, 100vw"},"sources":[{"srcSet":"/static/4145ff3a80750cd01cb79e68371a4484/a3156/createlibrary.webp 158w,\n/static/4145ff3a80750cd01cb79e68371a4484/a418d/createlibrary.webp 316w,\n/static/4145ff3a80750cd01cb79e68371a4484/334c8/createlibrary.webp 631w","type":"image/webp","sizes":"(min-width: 631px) 631px, 100vw"}]},"width":1280,"height":679.5562599049128}}},"image":{"publicURL":"/static/4145ff3a80750cd01cb79e68371a4484/createlibrary.png"}},"tableOfContents":"<ul>\n<li><a href=\"#planning\">Planning</a></li>\n<li><a href=\"#develop-setup\">Develop Setup</a></li>\n<li><a href=\"#bundle-setup\">Bundle Setup</a></li>\n<li><a href=\"#cicd-setup\">CI/CD Setup</a></li>\n<li><a href=\"#%E6%8E%A5%E4%B8%8B%E4%BE%86%E8%A8%AD%E5%AE%9A-custom-domain\">接下來設定 custom domain</a></li>\n<li><a href=\"#push-tag-and-create-release-with-tag\">Push Tag and Create Release with Tag</a></li>\n<li><a href=\"#%E5%BF%83%E5%BE%97\">心得</a></li>\n</ul>"},"previous":null,"next":{"fields":{"slug":"/2023-04-abortcontroller/"},"frontmatter":{"title":"AbortController in React, cancel in function call"}}},"pageContext":{"id":"ccfd436b-a7ca-58ad-91a7-f71f02cc1d9c","previousPostId":null,"nextPostId":"f12e6f17-9198-5610-9003-1a2eb2531122"}},"staticQueryHashes":["3649515864","3707347541","3761976949"],"slicesMap":{}}