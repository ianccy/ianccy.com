{"componentChunkName":"component---src-templates-post-tsx","path":"/reactlazyload/","result":{"data":{"site":{"siteMetadata":{"title":"Ian Chu"}},"markdownRemark":{"id":"58e0bb50-1d3d-5151-a3fd-d5a84ca87c08","excerpt":"最近身邊朋友問到 google speedtest 分數優化處理，剛好處理完網頁優化專案，雖然分數尚有進步空間…，lazyload 幾乎是網站必備的優化處理，分享一點處理 lazyload 心得。 首先拿出一個網站，然後在google speedtest…","html":"<p>最近身邊朋友問到 google speedtest 分數優化處理，剛好處理完網頁優化專案，雖然分數尚有進步空間…，lazyload 幾乎是網站必備的優化處理，分享一點處理 lazyload 心得。</p>\n<p>首先拿出一個網站，然後在<a href=\"https://developers.google.com/speed/pagespeed/insights/\" title=\"google speedtest\">google speedtest</a>輸入送出跑分，如果沒特別處理圖片的話，就會看到精美的項目出現 <code class=\"language-text\">延後載入畫面外圖片</code>。這代表網站沒有處理延後載入圖片。假設網站有多圖片、或高畫質圖片，那 lazyload image 是不錯的優化處理。</p>\n<p>lazyload 範例 : <a href=\"https://unsplash.com/\" title=\"unsplash\">unsplash</a></p>\n<p>上面的 unsplash 是知名的免費圖庫網站，它就有做了 lazyload 的處理，你再網頁往下滾過程，會發現區塊先有各種顏色的背景，再開始慢慢載入圖片。</p>\n<h2 id=\"google-guide-lazyload\" style=\"position:relative;\"><a href=\"#google-guide-lazyload\" aria-label=\"google guide lazyload permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Google Guide Lazyload</h2>\n<p>google 這篇文章，有非常詳盡的教學，告訴你每種處理方法之間的差異。(推薦看完)</p>\n<p>Google website Guide: <a href=\"https://developers.google.com/web/fundamentals/performance/lazy-loading-guidance/images-and-video/\" title=\"Lazy Loading Images\">Lazy Loading Images</a></p>\n<h2 id=\"實作方法-inline-images\" style=\"position:relative;\"><a href=\"#%E5%AF%A6%E4%BD%9C%E6%96%B9%E6%B3%95-inline-images\" aria-label=\"實作方法 inline images permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>實作方法 inline images</h2>\n<p>這是最常見的處理方法，直接利用 javascript 搭配 viewport 判斷，把圖片網址由 data-src 轉為加入 src 載入圖片 ，實際作法分為三種。Intersection observer、event handler、原生 chrome 支援。</p>\n<ul>\n<li>before\n<code class=\"language-text\">&lt;img data-src=\"https://fakeimg.pl/250x100/\" class=\"lazyload\"></code></li>\n<li>after\n<code class=\"language-text\">&lt;img src=\"https://fakeimg.pl/250x100/\"></code></li>\n</ul>\n<h3 id=\"intersection-observer\" style=\"position:relative;\"><a href=\"#intersection-observer\" aria-label=\"intersection observer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Intersection observer</h3>\n<p>IntersectionObserver 是新的瀏覽器 api，主要處理 element 與 viewport 之間處理，當目標與 element 交會則會處理互動，效能相對於傳統做法相對好。</p>\n<p>Google article: <a href=\"https://developers.google.com/web/updates/2019/02/intersectionobserver-v2\" title=\"Trust is Good, Observation is Better—Intersection Observer v2\">Trust is Good, Observation is Better—Intersection Observer v2</a></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> observer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntersectionObserver</span><span class=\"token punctuation\">(</span>callback<span class=\"token punctuation\">[</span><span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>上面的參數 callback 是當 viewport 與 element 交會時會觸發，options 則是可以使用 <code class=\"language-text\">root</code>、<code class=\"language-text\">rootMargin</code>、<code class=\"language-text\">threshold</code>。</p>\n<p>root 可以定義我們判斷這整個 viewport 的大外層，rootMargin 則是可以給予 root 大外層假想的 margin，讓我們可以讓外層 viewport 提早被觸發，進一步提早 callback，threshold 則是可以定義出 viewport 與 element 之間觸發的比例 0~1.0，預設為 0，當我設定 [0, 0.5, 1]，代表他會在三個 viewport 比例 callback。</p>\n<p>IntersectionObserver DOC:<a href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/IntersectionObserver/IntersectionObserver\" title=\"Intersection_Observer_API\">MDN Intersection_Observer_API</a></p>\n<p>這方法有非常大的問題，就是不支援全部瀏覽器，ie 全部不支援，需要引入 IntersectionObserver polyfill 處理，或是判斷 window API 有沒有 IntersectionObserver，沒有就走 event handler 方法，</p>\n<p>第一個方法缺點就是要載資源，背後實作也是用 scroll listener，沒有說你用了 polyfill 就享有效能好的福利，第二種方法缺點就是要維運兩套 lazyload trigger function，對開發來說成本頗高。</p>\n<p>caniuse intersectionObserver : <a href=\"https://caniuse.com/#feat=intersectionobserver\">悲劇的 IE</a> “悲劇的 IE”)</p>\n<p>頁面範例: <a href=\"https://codepen.io/chu1228/pen/QPXLBv?editors=0110\" title=\"codepen\">codepen demo</a></p>\n<h3 id=\"event-handler\" style=\"position:relative;\"><a href=\"#event-handler\" aria-label=\"event handler permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Event handler</h3>\n<p>這是最常見的做法，監聽瀏覽器滾動事件，利用 getBoundingClientRect().top，來判斷這個 element 是不是在使用者的視點內，如果在視點內的話，我們就將 img src 轉變成真正的 url，達到延後載入的效果。</p>\n<p>下面的範例是 google guide 的示範，基本上實作邏輯都差不多，會用到 scroll listener，搭配 throttle 避免 scroll 過度觸發判斷 function，當所有 element 完成 lazyload 移除 Listener，還有監聽 resize 畫面拉伸、orientationchange 倒換畫面。</p>\n<p>頁面範例: <a href=\"https://codepen.io/chu1228/pen/VNqaNQ\" title=\"codepen\">codepen demo</a></p>\n<h3 id=\"chrome-原生支援\" style=\"position:relative;\"><a href=\"#chrome-%E5%8E%9F%E7%94%9F%E6%94%AF%E6%8F%B4\" aria-label=\"chrome 原生支援 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Chrome 原生支援</h3>\n<p>chrome version 75 才會 release 的功能，現在可以先手動開啟設定，chrome 網址列輸入<code class=\"language-text\">chrome://flags/#enable-lazy-image-loading</code>，右邊選項改為 enabled。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">&lt;</span>img loading<span class=\"token operator\">=</span><span class=\"token string\">'lazy'</span> src<span class=\"token operator\">=</span><span class=\"token string\">'https://placekitten.com/400/400'</span> width<span class=\"token operator\">=</span><span class=\"token string\">'400'</span> height<span class=\"token operator\">=</span><span class=\"token string\">'400'</span> alt<span class=\"token operator\">=</span><span class=\"token string\">''</span><span class=\"token operator\">></span></code></pre></div>\n<p>頁面範例: <a href=\"https://mathiasbynens.be/demo/img-loading-lazy\" title=\"chrome lazyload demo\">chrome lazyload demo</a></p>\n<p>chromestatus: <a href=\"https://chromestatus.com/feature/5645767347798016\" title=\"chrome lazyload feature\">chrome lazyload feature</a></p>\n<h3 id=\"lazyload-套件\" style=\"position:relative;\"><a href=\"#lazyload-%E5%A5%97%E4%BB%B6\" aria-label=\"lazyload 套件 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>lazyload 套件</h3>\n<p>隨便搜尋 lazyload plugin，就會出現各種 lazyload 的套件，這邊就不贅述了。如果還是沒方向的話，我目前專案上有用到 lazySize，config 很多也是不錯用。</p>\n<h2 id=\"修飾畫面抖動問題\" style=\"position:relative;\"><a href=\"#%E4%BF%AE%E9%A3%BE%E7%95%AB%E9%9D%A2%E6%8A%96%E5%8B%95%E5%95%8F%E9%A1%8C\" aria-label=\"修飾畫面抖動問題 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>修飾畫面抖動問題</h2>\n<p>但你滾動會發現右邊的 scroll bar 會慢慢長出來，要解決的辦法就是必須模擬圖片高度，撐出 lazyload 的區塊。保持高度一致不抖動畫面。</p>\n<ul>\n<li>示範圖片\n<figure class=\"gatsby-resp-image-figure\" style=\"margin: 2vw 0;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/28fd55d5b3cedeb73eb29c319dc7f0cf/7dc98/rabbit.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.61616161616162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAACCUlEQVQoz2WQS09TYRCGz39y4ca4NHGBC2NYICQaFrogggaDTY5oCJpi1BgioJjSy7mfr+fSVhBwQbhIiuFSWzAKpaVovKx0qSH9HtPjZeMsZjKTmSfvvAr/h/ydj6R6uUs+UHslNJtAE/mjWSsWmt8+VVu99ByDk8ePySF1oLUTnSkfDmscHuzTOKhyUNujvr9Lo16VG+tFvIlRNmcKlEvrlLd3WFtdZTd/m9p2kcbHL+iJcTkS62EsrrK2ukzlzQaKlUnhmBrC0nGMqEpf2JiZKbkVvpT1+Veyd7Ag40+WZe3dhixOa3JYjcv2q4tyZnaFr40dufe2RNY2cE0NJeuYeI6JsIxo2AK3gK6lsfLcpTRv0NU/x/1UjZ/f3xPru07nqRPcHHYJ/TxwRHnrNcPqAOnEJEoLIOy/MAPX0vFsE9s0KHgWs0GaycwCiytlqpVZ4iOP6Ou5QOcVwfhEmru3YpxrO033+XYST8dRfNcizDqRSt+1I4XR+5aJcHTuPQ7ouLFJpbLL53qJ2JBDx8U7nLk0TSppMmeNEaZGyTspfOGgiIRGGPgEnvgHjPywDDzXIJn26FaXGHy4gOHM0X6tSFvfFmf7K+jJJPN+hqUZwYvAJvQEiqbnyOVyBIGPcJ3I2EDYETRrm/iOTj6bwTQ00ukMlmUyOZXl2ZRAWBrenw/znkPoufwCr6nn6UB6iygAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/28fd55d5b3cedeb73eb29c319dc7f0cf/a805d/rabbit.webp 495w,\n/static/28fd55d5b3cedeb73eb29c319dc7f0cf/36741/rabbit.webp 990w,\n/static/28fd55d5b3cedeb73eb29c319dc7f0cf/1e0b8/rabbit.webp 1200w\"\n              sizes=\"(max-width: 1200px) 100vw, 1200px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/28fd55d5b3cedeb73eb29c319dc7f0cf/b3db0/rabbit.png 495w,\n/static/28fd55d5b3cedeb73eb29c319dc7f0cf/8ddfd/rabbit.png 990w,\n/static/28fd55d5b3cedeb73eb29c319dc7f0cf/7dc98/rabbit.png 1200w\"\n            sizes=\"(max-width: 1200px) 100vw, 1200px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/28fd55d5b3cedeb73eb29c319dc7f0cf/7dc98/rabbit.png\"\n            alt=\"rabbit\"\n            title=\"rabbit\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">rabbit</figcaption>\n  </figure></li>\n</ul>\n<p>上面這張圖片的寬度是 2955、高度 1516，比例約是 29: 15，我們可以利用圖片比例來產生接近圖片實際大小的灰階區塊。</p>\n<p>接下來使用 padding-top 來撐出高度，因為我們用的是比例，所以畫面寬度變化，區塊的高度也會隨之變化。直接用上面的 IntersectionObserver 修改，多做的動作就是 img 要先填上各自的比例，當載入畫面時填上 padding-top，產生區塊的灰色高度。</p>\n<p>ps.codepen 的範例有加上 setTimeout 500ms，特意讓大家看到 lazyload 灰階區塊。</p>\n<ul>\n<li>Source code</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">document<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"DOMContentLoaded\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> lazyImages <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelectorAll</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"img.lazyload\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"IntersectionObserver\"</span> <span class=\"token keyword\">in</span> window<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> lazyImageObserver <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntersectionObserver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token parameter\">entries<span class=\"token punctuation\">,</span>\n      observer</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      entries<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">entry</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span>isIntersecting<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">let</span> lazyImage <span class=\"token operator\">=</span> entry<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">;</span>\n          lazyImage<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> lazyImage<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>src<span class=\"token punctuation\">;</span>\n          lazyImage<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lazyload\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n          <span class=\"token comment\">//clear padding-top</span>\n          lazyImage<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>paddingTop <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n          lazyImageObserver<span class=\"token punctuation\">.</span><span class=\"token function\">unobserve</span><span class=\"token punctuation\">(</span>lazyImage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    lazyImages<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">lazyImage</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// get image ratio</span>\n      <span class=\"token keyword\">var</span> ratio <span class=\"token operator\">=</span> lazyImage<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>ratio<span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// create padding-top</span>\n      lazyImage<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>paddingTop <span class=\"token operator\">=</span> ratio <span class=\"token operator\">+</span> <span class=\"token string\">\"%\"</span><span class=\"token punctuation\">;</span>\n      lazyImageObserver<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>lazyImage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Possibly fall back to a more compatible method here</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>頁面範例: <a href=\"https://codepen.io/chu1228/pen/BEgaKZ?editors=1010\" title=\"codepen\">codepen demo</a></p>\n<p>另外還可以加上 onload listener 讓載入圖片過程，保持 lazyload 灰色區塊。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">lazyImage<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> lazyImage<span class=\"token punctuation\">.</span>dataset<span class=\"token punctuation\">.</span>src<span class=\"token punctuation\">;</span>\nlazyImage<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  lazyImage<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lazyload\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">//clear padding-top</span>\n  lazyImage<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>paddingTop <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>w3c ration 教學:<a href=\"https://www.w3schools.com/howto/howto_css_aspect_ratio.asp\" title=\"Aspect Ratio / Height Equal to Width - W3Schools\">Aspect Ratio / Height Equal to Width - W3Schools</a></p>\n<h2 id=\"產生圖片比例-ratio\" style=\"position:relative;\"><a href=\"#%E7%94%A2%E7%94%9F%E5%9C%96%E7%89%87%E6%AF%94%E4%BE%8B-ratio\" aria-label=\"產生圖片比例 ratio permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>產生圖片比例 Ratio</h2>\n<p>這在實作上必須倚賴 javascript，或後端用其他工具產生，例如說圖片上傳過程後端會另外 call api，取得圖片的比例。</p>\n<p>這邊先只討論 javascript，利用 Image API 也可以輕鬆做到，下面的方法就可以拿到圖片的 ratio，setRatio 則是可以當作儲存圖片的方法，當使用者上傳圖片，會再經過 getImageRatio，再帶入 save data function 利用 callback，當取得圖片比例再提供 ratio 給後端儲存。</p>\n<p>這方法需要一個前提條件，一種是圖片寬度再 container 下需要寬滿版，因為 padding-top 推出來的高度，是相對於 container 寬度乘出來的。有些人會利用 div container img 概念處理，只要變化 container 寬度，一樣可以兼容 lazyload，medium 就是這樣處理的。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">getImageRatio</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> img <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  img<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>height <span class=\"token operator\">/</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  img<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> url<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">setRatio</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ratio</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>ratio<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token function\">getImageRatio</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://ianccy.com/images/rabbit.png\"</span><span class=\"token punctuation\">,</span> setRatio<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"seo-額外處理\" style=\"position:relative;\"><a href=\"#seo-%E9%A1%8D%E5%A4%96%E8%99%95%E7%90%86\" aria-label=\"seo 額外處理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>seo 額外處理</h2>\n<p>雖然 googlebot 可以執行 javascript，但是其他爬蟲不一定可以，所以要特別標明出 noscript 的 img html。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascripts\"><pre class=\"language-javascripts\"><code class=\"language-javascripts\">&lt;img class=&quot;lazyload&quot; data-ratio=&quot;51.24481327800829&quot; data-src=&quot;https://ianccy.com/images/rabbit.png&quot; alt=&quot;rabbit&quot;&gt;\n&lt;noscript&gt;&lt;img src=&quot;https://ianccy.com/images/rabbit.png&quot; alt=&quot;rabbit&quot; /&gt;&lt;/noscript&gt;</code></pre></div>\n<h2 id=\"心得\" style=\"position:relative;\"><a href=\"#%E5%BF%83%E5%BE%97\" aria-label=\"心得 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>心得</h2>\n<p>實際上處理 lazyload 是比較麻煩，要做出 lazyload 區塊灰階，就需要知道圖片比例。至於如何產生灰階，又分為存資料前預先做好 style，或載入頁面再依賴 javascript 產生。個人較偏向預先做好 style，減少使用使用者資源。</p>\n<p>為了優化效能，目前專案部分有使用 IntersectionObserver，但要支援萬惡的 IE，要再額外載入 polyfill，這點目前還在思考最佳解，目前是判斷 window 不含 IntersectionObserver 才會執行 polyfill。</p>\n<p>結論: lazy loading image 對網站是很合理的處理優化，使用者沒看到的區塊本來就不需要浪費網路載入。</p>\n<p>感謝閱讀，以上有問題歡迎留言，或是傳訊息。</p>\n<!--- ![lazyloading](../images/lazyloading.png \"lazyloading\") --->\n","fields":{"readingTime":{"text":"9 min read"}},"frontmatter":{"title":"lazy loading image 延後載入畫面外圖片","date":"April 25, 2019","description":"分享一點最近處理lazyload心得，lazy loading image 對網站是很合理的處理優化，使用者沒看到的區塊本來就不需要浪費網路載入。","categories":"javascript","tags":["frontend","seo"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#e8e8e8","images":{"fallback":{"src":"/static/675b990232abdf6b157bebf2953305da/520da/lazyloading.png","srcSet":"/static/675b990232abdf6b157bebf2953305da/17f1f/lazyloading.png 175w,\n/static/675b990232abdf6b157bebf2953305da/527dd/lazyloading.png 350w,\n/static/675b990232abdf6b157bebf2953305da/520da/lazyloading.png 700w","sizes":"(min-width: 700px) 700px, 100vw"},"sources":[{"srcSet":"/static/675b990232abdf6b157bebf2953305da/98832/lazyloading.webp 175w,\n/static/675b990232abdf6b157bebf2953305da/4a3fb/lazyloading.webp 350w,\n/static/675b990232abdf6b157bebf2953305da/31fe6/lazyloading.webp 700w","type":"image/webp","sizes":"(min-width: 700px) 700px, 100vw"}]},"width":1280,"height":780.8}}},"image":{"publicURL":"/static/675b990232abdf6b157bebf2953305da/lazyloading.png"}}},"previous":{"fields":{"slug":"/2019-03-society/"},"frontmatter":{"title":"聊聊4年前，剛出社會的我"}},"next":{"fields":{"slug":"/2019-05-googleformadv/"},"frontmatter":{"title":"Google Sheet RESTful API 試算表表單"}}},"pageContext":{"id":"58e0bb50-1d3d-5151-a3fd-d5a84ca87c08","previousPostId":"ad8a7f00-4c61-5a2d-bac4-649c32ac6558","nextPostId":"b6eefcc6-e75e-53f1-8474-4d3ea6d3410b"}},"staticQueryHashes":["3649515864","3761976949","441988385"]}