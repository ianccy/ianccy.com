{"componentChunkName":"component---src-templates-post-tsx","path":"/iframeblockcookie/","result":{"data":{"site":{"siteMetadata":{"title":"Ian Chu"}},"markdownRemark":{"id":"597a5f69-e54c-5c84-a11f-0041959bf90e","excerpt":"來分享個 cookie 相關的內容，是前陣子合作專案測試階段遇到的問題，發生情境是，合作廠商的手機瀏覽器會無法登入會員，主要都是 IOS 用戶。 提一下目前頁面會放置在對方網站上以 iframe 使用，用戶會點擊 iframe 內登入按鈕，轉導頁面，載入對應的登入 line、facebook…","html":"<p>來分享個 cookie 相關的內容，是前陣子合作專案測試階段遇到的問題，發生情境是，合作廠商的手機瀏覽器會無法登入會員，主要都是 IOS 用戶。</p>\n<p>提一下目前頁面會放置在對方網站上以 iframe 使用，用戶會點擊 iframe 內登入按鈕，轉導頁面，載入對應的登入 line、facebook 網頁等等，完成登入。</p>\n<h3 id=\"桌機手機版-登入流程\" style=\"position:relative;\"><a href=\"#%E6%A1%8C%E6%A9%9F%E6%89%8B%E6%A9%9F%E7%89%88-%E7%99%BB%E5%85%A5%E6%B5%81%E7%A8%8B\" aria-label=\"桌機手機版 登入流程 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>桌機、手機版 登入流程</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token literal-property property\">Desktop</span><span class=\"token operator\">:</span>\n<span class=\"token function\">website</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> click <span class=\"token parameter\">Login</span> <span class=\"token operator\">=></span> open <span class=\"token function\">window</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">=></span> login <span class=\"token parameter\">success</span> <span class=\"token operator\">=></span> postMessage to <span class=\"token function\">parent</span> <span class=\"token punctuation\">(</span> <span class=\"token parameter\">child close</span> <span class=\"token punctuation\">)</span>\n<span class=\"token operator\">=></span> parent <span class=\"token parameter\">reload</span> <span class=\"token operator\">=></span> done\n\n<span class=\"token literal-property property\">Mobile</span><span class=\"token operator\">:</span>\n<span class=\"token function\">website</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> click <span class=\"token parameter\">Login</span>\n<span class=\"token operator\">=></span> <span class=\"token parameter\">redirect</span> <span class=\"token operator\">=></span> login <span class=\"token parameter\">success</span> <span class=\"token operator\">=></span> done</code></pre></div>\n<ul>\n<li>登入流程 (簡易版)\n<figure class=\"gatsby-resp-image-figure\" style=\"margin: 2vw 0;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1404px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9d9f5124f98c48e9845588b1af4f6c58/132e7/loginflow.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.76767676767678%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAABb0lEQVR42p1T2W7CMBDM//8c4qkST0WqRCgJhBAnjnMMni2DHAQtqqVFrLM7M3s4QzzTNMF7j2EYMM+zGe9k4zia+b7HGP3fTsafPgaez2fUdQ3nHJqmMQIBiWQY6P8ByEAmSQlVSpnUV1VlRKfTCW3r0HUd8jzHbrfD8Xg0sgVgmkxlBGjb1giYvNlssF6vsVqtsN/vEUJAWZY4HA64XC4W9xKQAEVRWNlSzhiCqMckozoayaekr3dA9UnyU1/fRSBiGokWJT9Llj0DTQmp+OlQHtWlJJzq4/0joAm43Wd02FhOkANRKQy2ofgeQwQNobcY9pbf2UcaV45ldz78ADKJlzbdmMD1cK61IGO+7SJ9xolQ/5lnK0e1UWWmCfFjWZTwluAMWKUxOe0hfSrVQNJNMYWs3noVL7++a3x8FvYqBKjpwuJGW+rtdmvrla7cLIXpvrkuoGp88nqWU9dLkirt5l0h3jzvrNZLwBn/P1cW8pxbV+dDvwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/9d9f5124f98c48e9845588b1af4f6c58/a805d/loginflow.webp 495w,\n/static/9d9f5124f98c48e9845588b1af4f6c58/36741/loginflow.webp 990w,\n/static/9d9f5124f98c48e9845588b1af4f6c58/1539e/loginflow.webp 1404w\"\n              sizes=\"(max-width: 1404px) 100vw, 1404px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/9d9f5124f98c48e9845588b1af4f6c58/b3db0/loginflow.png 495w,\n/static/9d9f5124f98c48e9845588b1af4f6c58/8ddfd/loginflow.png 990w,\n/static/9d9f5124f98c48e9845588b1af4f6c58/132e7/loginflow.png 1404w\"\n            sizes=\"(max-width: 1404px) 100vw, 1404px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/9d9f5124f98c48e9845588b1af4f6c58/132e7/loginflow.png\"\n            alt=\"login flow\"\n            title=\"login flow\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">login flow</figcaption>\n  </figure></li>\n</ul>\n<p>登入是依賴 cookie，cookie 再交由後端驗證登入與否。經由測試後發現這些驗證請求都不會帶有 cookie，也就是說經由登入流程過後，cookie 沒有正確的存取到用戶的瀏覽器上。</p>\n<p>但合作方希望能跳過以上這些步驟，載入頁面時，直接 call 後端取得 token，直接塞入頁面。</p>\n<p>實際測試發現後端有正確建立這個 token，但就是前端 save cookie 那步驟有問題，於是開始轉向思考前端問題。</p>\n<h2 id=\"block-third-party-cookie\" style=\"position:relative;\"><a href=\"#block-third-party-cookie\" aria-label=\"block third party cookie permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Block third-party cookie</h2>\n<p>IOS 11 開始預設開啟 prevent cross-site tracking 的設定，這會導致第三方 cookie 無法設置，例如 google analytics、facebook pixel 等等，另外也包括了 iframe 內部網頁，這符合我們的情境。</p>\n<p>android 也同樣有這個設定，但目前沒有預設開啟。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Privacy by <span class=\"token keyword\">default</span>\nSafari’s key privacy features are enabled by <span class=\"token keyword\">default</span><span class=\"token punctuation\">.</span>\nFor example<span class=\"token punctuation\">,</span> <span class=\"token keyword\">in</span> iOS<span class=\"token punctuation\">,</span> Intelligent Tracking <span class=\"token function\">Prevention</span>\n<span class=\"token punctuation\">(</span>shown <span class=\"token keyword\">in</span> Settings <span class=\"token keyword\">as</span> Prevent Cross<span class=\"token operator\">-</span>Site Tracking<span class=\"token punctuation\">)</span>\nis turned on by <span class=\"token keyword\">default</span><span class=\"token punctuation\">.</span> Camera<span class=\"token punctuation\">,</span> microphone<span class=\"token punctuation\">,</span>\nand location are <span class=\"token keyword\">set</span> to ask <span class=\"token keyword\">for</span> permission before granting access<span class=\"token punctuation\">.</span></code></pre></div>\n<p>官方文件: <a href=\"https://www.apple.com/safari/docs/Safari_White_Paper_Nov_2019.pdf\" title=\"Safari Privacy Overview \">Safari Privacy Overview </a></p>\n<h2 id=\"解決-block-third-party-cookie\" style=\"position:relative;\"><a href=\"#%E8%A7%A3%E6%B1%BA-block-third-party-cookie\" aria-label=\"解決 block third party cookie permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>解決 Block third-party Cookie</h2>\n<p>查了網路後，發現有個方法可以繞過 safari 阻擋 cookie，<code class=\"language-text\">就是要載入該 domain 並且設定一個 cookie 在該網域上</code>，之後 iframe 就可以設定 cookie 了。</p>\n<p>ps.最新的 safari 13.1 擋掉了這個方法，ooxx…。</p>\n<p>但是在 chrome，就無法這樣處理了，android 實現阻擋的方法不一樣，它是讓 third-party 可以存 cookie，但是無法取出 cookie。</p>\n<p>若要完美處理 Block third-party Cookie 唯一解法就是改用 local Storage 或是 Session Storage，前幾天在 Line Liff 上看到也是用 Session Storage 來處理 token。</p>\n<h2 id=\"頁面無法倒轉情況\" style=\"position:relative;\"><a href=\"#%E9%A0%81%E9%9D%A2%E7%84%A1%E6%B3%95%E5%80%92%E8%BD%89%E6%83%85%E6%B3%81\" aria-label=\"頁面無法倒轉情況 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>頁面無法倒轉情況</h2>\n<p>最近桌機 safari 的某個與 cookie 相關功能失效，就是因為 block third-party cookie 導致，那時同事 hotfix 做法非常簡單暴力，就是判斷 safari，直接轉導頁面過去 set cookie，再轉導回來。</p>\n<h2 id=\"心得\" style=\"position:relative;\"><a href=\"#%E5%BF%83%E5%BE%97\" aria-label=\"心得 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>心得</h2>\n<p>寫這篇是希望有人遇到 cookie 無法設定的問題，提供一些解決的方法。</p>\n<p>另外還有 Web in app 時，也有很多狀態需要確認，每個 app 可能都有不一樣的設定，推薦大家一個 debug 工具，這工具可以會顯示 element、console、network、web storage，可以大量減少手機裝置 debug 的痛苦，web in app 無法連線桌機的 devTool 極高痛苦度。</p>\n<p>工具: <a href=\"https://github.com/Tencent/vConsole\" title=\"Tencent vConsole\">Tencent vConsole</a></p>\n<p>前幾天 google 公告兩年後要全面阻擋第三方 cookie，這對於前端又是很大的考驗，看來未來要開發上，要多思考無法避免成為第三方狀況下，轉而使用 Session Storage、Local Storage。</p>\n<p>感謝閱讀!!</p>\n<!--- ![block cookie](../images/blockcookie.png \"block cookie\") --->\n","fields":{"readingTime":{"text":"5 min read"}},"frontmatter":{"title":"阻擋第三方(Block third-party) Cookie，各瀏覽器狀態","date":"December 11, 2019","description":"IOS 11 開始預設開啟 prevent cross-site tracking 的設定，這會導致第三方 cookie 無法設置，若要完美處理 Block third-party Cookie 唯一解法就是改用 local Storage 或是 Session Storage。","categories":"javascript","tags":["javascript"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#181818","images":{"fallback":{"src":"/static/1c41405e1cfd8c04bb8410c46e89822a/25318/blockcookie.jpg","srcSet":"/static/1c41405e1cfd8c04bb8410c46e89822a/21cb7/blockcookie.jpg 223w,\n/static/1c41405e1cfd8c04bb8410c46e89822a/b74d6/blockcookie.jpg 445w,\n/static/1c41405e1cfd8c04bb8410c46e89822a/25318/blockcookie.jpg 890w","sizes":"(min-width: 890px) 890px, 100vw"},"sources":[{"srcSet":"/static/1c41405e1cfd8c04bb8410c46e89822a/05bc1/blockcookie.webp 223w,\n/static/1c41405e1cfd8c04bb8410c46e89822a/50fdb/blockcookie.webp 445w,\n/static/1c41405e1cfd8c04bb8410c46e89822a/a594b/blockcookie.webp 890w","type":"image/webp","sizes":"(min-width: 890px) 890px, 100vw"}]},"width":1280,"height":629.9325842696629}}},"image":{"publicURL":"/static/1c41405e1cfd8c04bb8410c46e89822a/blockcookie.png"}},"tableOfContents":"<ul>\n<li>\n<ul>\n<li><a href=\"#%E6%A1%8C%E6%A9%9F%E6%89%8B%E6%A9%9F%E7%89%88-%E7%99%BB%E5%85%A5%E6%B5%81%E7%A8%8B\">桌機、手機版 登入流程</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#block-third-party-cookie\">Block third-party cookie</a></p>\n</li>\n<li>\n<p><a href=\"#%E8%A7%A3%E6%B1%BA-block-third-party-cookie\">解決 Block third-party Cookie</a></p>\n</li>\n<li>\n<p><a href=\"#%E9%A0%81%E9%9D%A2%E7%84%A1%E6%B3%95%E5%80%92%E8%BD%89%E6%83%85%E6%B3%81\">頁面無法倒轉情況</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%BF%83%E5%BE%97\">心得</a></p>\n</li>\n</ul>"},"previous":{"fields":{"slug":"/2020-02-reactpuppeteer/"},"frontmatter":{"title":"Puppeteer End-to-End Test React"}},"next":{"fields":{"slug":"/2019-11-reduxdispatch/"},"frontmatter":{"title":"Redux multiple dispatch，batch redux-thunk"}}},"pageContext":{"id":"597a5f69-e54c-5c84-a11f-0041959bf90e","previousPostId":"488ce399-f7c8-50c4-a7ad-e0ee7917861e","nextPostId":"c2437748-cd93-540a-a478-bc4541bcf978"}},"staticQueryHashes":["3649515864","3707347541","3761976949"],"slicesMap":{}}