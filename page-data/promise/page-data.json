{"componentChunkName":"component---src-templates-post-tsx","path":"/promise/","result":{"data":{"site":{"siteMetadata":{"title":"Ian Chu"}},"markdownRemark":{"id":"62905755-12f0-5557-8492-102db86c5fad","excerpt":"Javascript 在 ES6 新增了大量非常實用的功能，其中重要一項就是 Promsie，讓我們可以很直覺的處理非同步，在以前如果我們需要同時發出多個非同步請求，就必須在每次調用 function 時，一起在參數帶回 callback 的 function，重複了幾次就變成了波動拳。 接下來會用 promise…","html":"<p>Javascript 在 ES6 新增了大量非常實用的功能，其中重要一項就是 Promsie，讓我們可以很直覺的處理非同步，在以前如果我們需要同時發出多個非同步請求，就必須在每次調用 function 時，一起在參數帶回 callback 的 function，重複了幾次就變成了波動拳。</p>\n<p>接下來會用 promise 處理 callback hell，還有建立一個簡易的 promise，幫助我們理解 promise。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin: 2vw 0;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 800px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/45d93443ae8910c4adb84870e715d286/acfc1/callbackhell.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.717171717171716%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABl0lEQVR42p2Rz07bQBCHfYZTilASAq7AsXe9duL/XjtxcEoPpe6dqkJCRDa0PThBsh8jeYamL+pfZbulQCskOHya2VnNt7O7wnb7s/pyeYWv375XaZbi5jZDdpP9N6ZZhuvrBRaLx6RphouLz/ix3ULI8yU6+2JluDHYSAczZOimAtNXYbgUI5tg7JD7/EgU0e320Ov17xkMDrGzs4s8zyGUZVnVBYefVeHpBwTTEDyyMY09zN5zzM58TGIP0dxH9K7OfahMg6IQEEIbGNMaaVmWEIqibE6klGFkTeGFc1iuBYcbcLmJYGbDC034EwteaCGIbDjchKwQDIcyZFlppPWkRVHUwqJZEEJAqAbXj+DxCRzeivjUhheYsL0xbN9oohuY0Mc6htKzwnZ8jRGoKgNlGpiugqq0aaqnecqf+j/CbrffvguhkKTfDdKwzaW/zQ95KH0iLHEwOISmj5rN+rFfSn2jfv+g/ZTV6g57e/s4Pj6BKL59FXVvp/MGy+UKwmazQRzPkSQJzs8/vook+YQ4jrFer/ELa/JKM27o42sAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/45d93443ae8910c4adb84870e715d286/a805d/callbackhell.webp 495w,\n/static/45d93443ae8910c4adb84870e715d286/6ec60/callbackhell.webp 800w\"\n              sizes=\"(max-width: 800px) 100vw, 800px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/45d93443ae8910c4adb84870e715d286/b3db0/callbackhell.png 495w,\n/static/45d93443ae8910c4adb84870e715d286/acfc1/callbackhell.png 800w\"\n            sizes=\"(max-width: 800px) 100vw, 800px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/45d93443ae8910c4adb84870e715d286/acfc1/callbackhell.png\"\n            alt=\"javascript callback hell\"\n            title=\"javascript callback hell\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">javascript callback hell</figcaption>\n  </figure></p>\n<h2 id=\"簡易的-promise\" style=\"position:relative;\"><a href=\"#%E7%B0%A1%E6%98%93%E7%9A%84-promise\" aria-label=\"簡易的 promise permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>簡易的 Promise</h2>\n<p>複雜專案可能會出現的波動拳，這畫面我真實有看過…，假設換成用 promise 的話，就可以很輕鬆直覺處理掉，首先我們先建立一個簡單的 ajax function sample code，下面會用 es6 來寫，希望能在整個流程中，讓你了解 es6 的方便。</p>\n<p>宣告一個 getData arrow function，裡面包含 XMLHttpRequest，我們監聽 onreadystatechange，當整個成功取得資料，就調用 resolve 來進行 callback 把資料放進 resolve function 傳遞，當取得資料失敗就調用 reject function 來傳遞資料。</p>\n<p>當我們 new 一個 promise 的同時，我們 callback function 是帶入 function(resolve, reject){resolve or reject}，讓內部 promise function 被我們用 resolve 或是 reject 調用。</p>\n<ul>\n<li>promise 三種狀態</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">擱置（pending）：初始狀態，不是 fulfilled 與 rejected。\n實現（fulfilled）：表示操作成功地完成。\n拒絕（rejected）：表示操作失敗了。</code></pre></div>\n<p>promise 會等待佇列 pending 狀態，等到被 resolve 觸發 fulfilled，就會開始回調 then，或是被 reject 觸發 catch。</p>\n<p>then 以及 catch 都會回傳一個 promise，也就是說可以<code class=\"language-text\">.then(()=>{}).then(()=>{}).then(()=>{})</code>除非有錯誤產生，否則會往下調用下去。<code class=\"language-text\">.catch(()=>{}).catch(()=>{}).catch(()=>{})</code>則是當 javascript 有錯誤發生，會開始向下 catch，直到沒錯誤為止才會調用 catch function，同時因為沒錯誤所以會停住。</p>\n<ul>\n<li>非同步 function 範例</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// declare arrow function return Promise</span>\n<span class=\"token comment\">// ** new Promise to inherit Promise instance **</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getData</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">url</span> <span class=\"token operator\">=></span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// create http request</span>\n        <span class=\"token keyword\">const</span> xhttp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">XMLHttpRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        xhttp<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onreadystatechange</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>xhttp<span class=\"token punctuation\">.</span>readyState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>xhttp<span class=\"token punctuation\">.</span>readyState <span class=\"token operator\">===</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>xhttp<span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token number\">200</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\">// resolve will trigger Promise then callback</span>\n                    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>xhttp<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>xhttp<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\">// reject will trigger Promise catch callback</span>\n                    <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>xhttp<span class=\"token punctuation\">.</span>statusText<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        xhttp<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        xhttp<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://jsonplaceholder.typicode.com/todos/1'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// destructuring object</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">,</span> completed <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> res<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> html <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;div class=\"item\">\n                    &lt;p>Id: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/p>\n                    &lt;div>Title: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>title<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/div>\n                    &lt;div>Completed: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>completed<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/div>\n                  &lt;/div></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> newNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        newNode<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> html<span class=\"token punctuation\">;</span>\n        document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#list'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>newNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// it will run when promise Reject or</span>\n    <span class=\"token comment\">// in then function appear javascript error</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Something Error ,because </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>res<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<iframe src=\"//codepen.io/chu1228/embed/yZrVKW/?height=400&theme-id=0&default-tab=js\" width=\"100%\" height=\"400\"></iframe>\n<p><a href=\"https://codepen.io/chu1228/pen/yZrVKW?editors=1111\" title=\"codepen promise demo\">codepen promise demo</a></p>\n<h2 id=\"promise-解決-callback-hell\" style=\"position:relative;\"><a href=\"#promise-%E8%A7%A3%E6%B1%BA-callback-hell\" aria-label=\"promise 解決 callback hell permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Promise 解決 callback hell</h2>\n<p>那如果我們要繼續拉第二筆資料 /todos/2，這時候就能展現 promise 方便了，當拉完資料後，再回傳一個 promise，再用 then catch 去接受回傳值，反覆下去延伸。</p>\n<p>這樣的寫法優點是比起以往依賴 callback 更直覺，另外每次都分同步取資料都可能會失敗。也很容易針對每個段點做不同的錯誤處理。</p>\n<ul>\n<li>add more callback</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">...</span>\n<span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://jsonplaceholder.typicode.com/todos/1'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">appendItem</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// return getData promise</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://jsonplaceholder.typicode.com/todos/2'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'top'</span><span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// it will start next promise then catch</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">appendItem</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">getData</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://jsonplaceholder.typicode.com/todos/3'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'middle'</span><span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">appendItem</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'bottom'</span><span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// append html function</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">appendItem</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// prevent get null or undefined trigger .catch</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>res<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> id<span class=\"token punctuation\">,</span> title<span class=\"token punctuation\">,</span> completed <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> res<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> html <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;div class=\"item\">\n                    &lt;div>Id: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/div>\n                    &lt;div>Title: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>title<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/div>\n                    &lt;div>Completed: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>completed<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/div>\n                  &lt;/div></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> newNode <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    newNode<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> html<span class=\"token punctuation\">;</span>\n    document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#list'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>newNode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<iframe src=\"//codepen.io/chu1228/embed/yZrMRE/?height=409&theme-id=0&default-tab=js\" width=\"100%\" height=\"410\"></iframe>\n<p><a href=\"https://codepen.io/chu1228/pen/yZrMRE?editors=1111\" title=\"codepen promise demo\">codepen promise demo</a></p>\n<h2 id=\"實現-promise\" style=\"position:relative;\"><a href=\"#%E5%AF%A6%E7%8F%BE-promise\" aria-label=\"實現 promise permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>實現 promise</h2>\n<p>promise 就像是個魔術，直到 es6 以前都很難處理好分同步處理，我們來試著做一個只單純帶有 then catch 簡易的 promise，來幫助我們更了解 promise。</p>\n<p>先來解讀一下 promise，他是依賴 resolve、reject function 調用的，直接 <code class=\"language-text\">new Promise(()=>{})</code>，可以看到 promise 內部的狀態，有 status、value、then、catch、finally，這邊就先不理會 finally。</p>\n<ul>\n<li>Promise native prototype</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Promise <span class=\"token punctuation\">{</span><span class=\"token operator\">&lt;</span>pending<span class=\"token operator\">></span><span class=\"token punctuation\">}</span>\n  <span class=\"token literal-property property\">__proto__</span><span class=\"token operator\">:</span> Promise\n  <span class=\"token literal-property property\">catch</span><span class=\"token operator\">:</span> ƒ <span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token literal-property property\">constructor</span><span class=\"token operator\">:</span> ƒ <span class=\"token function\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token literal-property property\">finally</span><span class=\"token operator\">:</span> ƒ <span class=\"token function\">finally</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token literal-property property\">then</span><span class=\"token operator\">:</span> ƒ <span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span>Symbol<span class=\"token punctuation\">.</span>toStringTag<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Promise\"</span>\n  <span class=\"token literal-property property\">__proto__</span><span class=\"token operator\">:</span> Object\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>PromiseStatus<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pending\"</span>\n  <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>PromiseValue<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> <span class=\"token keyword\">undefined</span></code></pre></div>\n<p>首先先用 es6 class 建立一個 promise，依照 promise 內部 code，我們也建立內部的變數 status 以及 value，status 是讓我們判斷 pending 或是 fullfill reject 狀態，value 則是用來接帶進來的值。</p>\n<p>這邊比較容易看不懂的是 constructor(callback)，這個 callback 指的是 new Promise( <code class=\"language-text\">(res,rej)=>{ res('Hello')}</code> )，簡單講就是你帶進來的 function。我們在使用 promise 會用到兩個 function，reslove 以及 reject，我們也依樣畫葫蘆，依樣命名一個 resolve、reject，依照(resolve,reject)順序帶入 callback，帶進來讓使用者可以調用到。當我們在外部使用第一個 function，就會調用到內部的 reslove，如果是第二個的話則是調用到內部的 reject。</p>\n<p>距離實際的 promise 還缺少了 then、catch，接下來再繼續實作。</p>\n<ul>\n<li>build promise</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">promise</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// promise status</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> <span class=\"token string\">'pending'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// create variable to store resolve or reject value</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// resolve is not outside resolve</span>\n        <span class=\"token comment\">// it is use to pass callback function first function</span>\n\n        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'pending'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> <span class=\"token string\">'fullfilled'</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> res<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// reject is not outside reject</span>\n        <span class=\"token comment\">// it is use to pass callback function second function</span>\n        <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">reject</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">res</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>status <span class=\"token operator\">!==</span> <span class=\"token string\">'pending'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> <span class=\"token string\">'rejected'</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> res<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// it's keypoint to call reslove or reject function</span>\n        <span class=\"token comment\">// reslove or reject just assign status and value</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// this resolve is upper resolve function</span>\n            <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> reject<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>加上 then catch 接受回傳值</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">...</span>\n  <span class=\"token comment\">// then will let user call to check status</span>\n  <span class=\"token function-variable function\">then</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">success<span class=\"token punctuation\">,</span> failed</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">then</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'fulfilled'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>status <span class=\"token operator\">===</span> <span class=\"token string\">'rejected'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">failed</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// it will call then function and callback second callback function</span>\n  <span class=\"token function-variable function\">catch</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">cb</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>cb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p><a href=\"https://codepen.io/chu1228/pen/pGmLez?editors=0011\" title=\"codepen promise build\">codepen promise build</a></p>\n<p>到這裡只是很簡單的 promise 大致上執行邏輯而已，方便我們更好理解 promise 原理，要完整實現還有很多細節要處理，例如說要 then 或是 catch 要 return promise，還有 all race finally 沒有寫上去。你可以看一下更多完整功能要怎實現出來。</p>\n<p><a href=\"https://gist.github.com/vkarpov15/169d61f210c3420accf96f2081ad716d\" title=\"vkarpov15/promise.js\">vkarpov15/promise.js</a></p>\n<p>雖然每次用 promise 都很理所當然，規則已經既定是如此，但如果每次使用都能了解背後原理，能夠以不同角度來看待，我自己覺得對我來說，幫助都很大，最近正在無盡的的優化網頁效能，無限感慨中…。</p>\n<p>如果有錯誤歡迎留言，感謝閱讀。</p>","fields":{"readingTime":{"text":"8 min read"}},"frontmatter":{"title":"Javascript Promise example 簡易實作模擬","date":"February 18, 2019","description":"接下來會用 promise 處理 callback hell，還有建立一個簡易的 promise，幫助我們理解promise。","categories":"javascript","tags":["javascript"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#282828","images":{"fallback":{"src":"/static/45d93443ae8910c4adb84870e715d286/28b0a/callbackhell.png","srcSet":"/static/45d93443ae8910c4adb84870e715d286/72f29/callbackhell.png 200w,\n/static/45d93443ae8910c4adb84870e715d286/465f1/callbackhell.png 400w,\n/static/45d93443ae8910c4adb84870e715d286/28b0a/callbackhell.png 800w","sizes":"(min-width: 800px) 800px, 100vw"},"sources":[{"srcSet":"/static/45d93443ae8910c4adb84870e715d286/0518f/callbackhell.webp 200w,\n/static/45d93443ae8910c4adb84870e715d286/dccb0/callbackhell.webp 400w,\n/static/45d93443ae8910c4adb84870e715d286/35be4/callbackhell.webp 800w","type":"image/webp","sizes":"(min-width: 800px) 800px, 100vw"}]},"width":1280,"height":662.4}}},"image":{"publicURL":"/static/45d93443ae8910c4adb84870e715d286/callbackhell.png"}},"tableOfContents":"<ul>\n<li><a href=\"#%E7%B0%A1%E6%98%93%E7%9A%84-promise\">簡易的 Promise</a></li>\n<li><a href=\"#promise-%E8%A7%A3%E6%B1%BA-callback-hell\">Promise 解決 callback hell</a></li>\n<li><a href=\"#%E5%AF%A6%E7%8F%BE-promise\">實現 promise</a></li>\n</ul>"},"previous":{"fields":{"slug":"/2019-02-keywordselect/"},"frontmatter":{"title":"SEO關鍵字分析選擇，優化工具介紹"}},"next":{"fields":{"slug":"/2019-01-reactssr/"},"frontmatter":{"title":"React Server-side rendering SEO處理"}}},"pageContext":{"id":"62905755-12f0-5557-8492-102db86c5fad","previousPostId":"dc507d69-9f29-5c53-b970-10655ad6a861","nextPostId":"20d27da2-d557-5981-8a2d-bd1a2def444f"}},"staticQueryHashes":["3649515864","3707347541","3761976949"],"slicesMap":{}}