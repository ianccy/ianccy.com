{"componentChunkName":"component---src-templates-post-tsx","path":"/imgprogress/","result":{"data":{"site":{"siteMetadata":{"title":"Ian Chu"}},"markdownRemark":{"id":"670aa326-aa76-598f-b15c-d5188724554a","excerpt":"最近剛好要使用圖片上傳的功能，但因為資源較少，所以考慮用網路上的 image api 服務，稍微研究後選擇 imgur 的服務。以前拖拉上傳，都是用套件處理掉，剛好來研究一下如何處理拖拉上傳圖片，附加進度條功能。 我們需要取得 imgur api，再來使用 input 處理上傳檔案，檔案串接上傳 imgur api…","html":"<p>最近剛好要使用圖片上傳的功能，但因為資源較少，所以考慮用網路上的 image api 服務，稍微研究後選擇 imgur 的服務。以前拖拉上傳，都是用套件處理掉，剛好來研究一下如何處理拖拉上傳圖片，附加進度條功能。</p>\n<p>我們需要取得 imgur api，再來使用 input 處理上傳檔案，檔案串接上傳 imgur api，在處理 drag and drop 拖拉上傳檔案，完成後也要串接 imgur api。</p>\n<p>完成頁面: <a href=\"https://test.ianccy.com/imgur/\" title=\"Drop file demo\">Drop upload demo</a></p>\n<h2 id=\"申請-imgur-api-key\" style=\"position:relative;\"><a href=\"#%E7%94%B3%E8%AB%8B-imgur-api-key\" aria-label=\"申請 imgur api key permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>申請 imgur api key</h2>\n<p>首先進入 imgur 申請帳號登入，再點選下方的連結，申請屬於自己的 Client ID。後面 call api 會需要使用。</p>\n<p><a href=\"https://api.imgur.com/oauth2/addclient\" title=\"imgur Register an Application\">imgur Register an Application</a></p>\n<p>查看 imgur 提供的 restful api post image，需要帶的有 header client ID，body 則需要有格式\n<code class=\"language-text\">image</code> A binary file, base64 data, URL for image.限制 10MB 以下，其他則是選填 album(optional)、title、description、name、type。</p>\n<p><a href=\"https://apidocs.imgur.com/#c85c9dfc-7487-4de2-9ecd-66f727cf3139\" title=\"imgur upload api post\">imgur upload api post</a></p>\n<ul>\n<li>imgur jquery ajax sample</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> form <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FormData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nform<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>\n  <span class=\"token string\">\"image\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">\"R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7\"</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> settings <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">async</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">crossDomain</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://api.imgur.com/3/image\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">method</span><span class=\"token operator\">:</span> <span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">Authorization</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Client-ID {{clientId}}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">processData</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">contentType</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">mimeType</span><span class=\"token operator\">:</span> <span class=\"token string\">\"multipart/form-data\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> form<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n$<span class=\"token punctuation\">.</span><span class=\"token function\">ajax</span><span class=\"token punctuation\">(</span>settings<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"傳統-input-上傳\" style=\"position:relative;\"><a href=\"#%E5%82%B3%E7%B5%B1-input-%E4%B8%8A%E5%82%B3\" aria-label=\"傳統 input 上傳 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>傳統 input 上傳</h2>\n<p>先簡易的傳統的點擊 input 上傳檔案，首先創建 input tag，type 選擇 file，再來監聽這個 input 有沒有變化，如果他有變化的話，代表獲取到檔案上傳，我們就要轉出這個檔案。</p>\n<p>對了，官網範例是用 jquery ajax，為了方便我們直接拿來用，記得要引入 jquery library。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">...</span>\n<span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>input type<span class=\"token operator\">=</span><span class=\"token string\">\"file\"</span> accept<span class=\"token operator\">=</span><span class=\"token string\">\"image/*\"</span> id<span class=\"token operator\">=</span><span class=\"token string\">\"imageUpload\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>img id<span class=\"token operator\">=</span><span class=\"token string\">\"imagePreview\"</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n    <span class=\"token comment\">// listen input change call handleFiles</span>\n    document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#imageUpload'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'change'</span><span class=\"token punctuation\">,</span>handleFiles<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">function</span> <span class=\"token function\">handleFiles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// get input files object</span>\n      <span class=\"token keyword\">var</span> fileList <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">;</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>fileList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// call ajax</span>\n        <span class=\"token function\">upload</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token operator\">...</span></code></pre></div>\n<p>接到檔案後，直接用官網的 sample，調用 ajax post api，headers 帶 Authorization 用產生的 client id，以檔案作為參數。</p>\n<p>完成上傳後，api 會回傳 json 的 string type，所以接到 api 回傳後，要用 JSON.parse 轉成 json type，再取出 link 圖片的網址。這樣就完成了 imgur 的 api 串接。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">...</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">upload</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">var</span> form <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FormData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      form<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"image\"</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">var</span> settings <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string-property property\">\"async\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"crossDomain\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://api.imgur.com/3/image\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"method\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"headers\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token string-property property\">\"Authorization\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Client-ID {{clientId}}\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"processData\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"contentType\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"mimeType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"multipart/form-data\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"data\"</span><span class=\"token operator\">:</span> form\n      <span class=\"token punctuation\">}</span>\n\n      $<span class=\"token punctuation\">.</span><span class=\"token function\">ajax</span><span class=\"token punctuation\">(</span>settings<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// get respon string type json</span>\n        <span class=\"token keyword\">var</span> res <span class=\"token operator\">=</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>link<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"imagePreview\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> res<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>link<span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>body<span class=\"token operator\">></span></code></pre></div>\n<ul>\n<li>input upload imgur demo</li>\n</ul>\n<iframe src=\"https://test.ianccy.com/imgur/try.html\" width=\"100%\" height=\"430\"></iframe>\n<h2 id=\"上傳檔案-progress-bar\" style=\"position:relative;\"><a href=\"#%E4%B8%8A%E5%82%B3%E6%AA%94%E6%A1%88-progress-bar\" aria-label=\"上傳檔案 progress bar permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>上傳檔案 progress bar</h2>\n<p>製作上傳進度條，就需要監聽上傳檔案的進度，在 jquey ajax 在增加 option xhr，延展 jquery 具有 xhr 特性，在使用 xhr 監聽 upload 事件，取得目前上傳檔案的 size，在除以整個檔案後取的比例，再將這個比例帶進 progress bar value，這樣就完成了上傳進度條。</p>\n<p>提醒 fetch 無法使用進度條監聽事件，axios、原生 xmlhttprequest 都有方法實作進度條。</p>\n<p>實作方法 : <a href=\"https://github.com/axios/axios#request-config\" title=\"axios onUploadProgress\">axios onUploadProgress</a>、<a href=\"https://developer.mozilla.org/zh-TW/docs/Web/API/XMLHttpRequest/Using_XMLHttpRequest#%E7%9B%A3%E8%A6%96%E9%80%B2%E5%BA%A6\" title=\"xmlhttprequest mdn progress bar\">xmlhttprequest mdn progress bar</a></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token comment\">// add progress bar element</span>\n  <span class=\"token operator\">&lt;</span>progress id<span class=\"token operator\">=</span><span class=\"token string\">\"progress\"</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"display:none\"</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> max<span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>progress<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>img id<span class=\"token operator\">=</span><span class=\"token string\">\"imagePreview\"</span> onload<span class=\"token operator\">=</span><span class=\"token string\">\"hideProgress()\"</span><span class=\"token operator\">></span>\n<span class=\"token operator\">...</span>\n        <span class=\"token string-property property\">\"mimeType\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"multipart/form-data\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string-property property\">\"data\"</span><span class=\"token operator\">:</span> form<span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// add xhr to extend ajax</span>\n        <span class=\"token string-property property\">\"xhr\"</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">var</span> myXhr <span class=\"token operator\">=</span> $<span class=\"token punctuation\">.</span>ajaxSettings<span class=\"token punctuation\">.</span><span class=\"token function\">xhr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>myXhr<span class=\"token punctuation\">.</span>upload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                myXhr<span class=\"token punctuation\">.</span>upload<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'progress'</span><span class=\"token punctuation\">,</span>progress<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">return</span> myXhr<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token operator\">...</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">progress</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>lengthComputable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> length <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>total<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> current <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>loaded<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> progress <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'progress'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">var</span> percent <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>current <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token operator\">/</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    progress<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> percent<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>progress<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>display <span class=\"token operator\">!==</span> <span class=\"token string\">'block'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      progress<span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>display <span class=\"token operator\">=</span> <span class=\"token string\">'block'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n <span class=\"token punctuation\">}</span>\n <span class=\"token keyword\">function</span> <span class=\"token function\">hideProgress</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'progress'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>display <span class=\"token operator\">=</span> <span class=\"token string\">'none'</span><span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>upload progress version</li>\n</ul>\n<iframe src=\"https://test.ianccy.com/imgur/try2.html\" width=\"100%\" height=\"450\"></iframe>\n<h2 id=\"拖拉上傳檔案\" style=\"position:relative;\"><a href=\"#%E6%8B%96%E6%8B%89%E4%B8%8A%E5%82%B3%E6%AA%94%E6%A1%88\" aria-label=\"拖拉上傳檔案 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>拖拉上傳檔案</h2>\n<p>這邊會是技術比較複雜的部分，一般網頁開發比較少用到 drag，首先要了解拖拉物件，會觸發哪些 event，拖拉過程怎麼帶資料互動，</p>\n<p>稍微測試每個事件觸發點，當我開始拖拉一個物件，會先觸發 dragstart => drag => dragenter / dragover / dragleave / dragexit => drop => dropend，也就是說拖拉物件到放置另一個區塊，會觸發 drop、dropend，其中 drop 會再被放置到有效區塊才會觸發，而且 dragend 無法以外部拖拉檔案觸發，所以我們只要監聽 drop 就好了。</p>\n<ul>\n<li>HTML drag API</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">drag 於一個元素或文字選取區塊被拖曳時觸發。\ndragend\t於拖曳操作結束時觸發（如放開滑鼠按鍵或按下鍵盤的 escape 鍵。\ndragenter 於一個元素或文字選取區塊被拖曳移動進入一個有效的放置目標時觸發。\ndragexit  當一個元素不再是被選取中的拖曳元素時觸發。\ndragleave 於一個元素或文字選取區塊被拖曳移動離開一個有效的放置目標時觸發。\ndragover  於一個元素或文字選取區塊被拖曳移動經過一個有效的放置目標時觸發\ndragstart 於使用者開始拖曳一個元素或文字選取區塊時觸發。\ndrop 於一個元素或文字選取區塊被放置至一個有效的放置目標時觸發。\n\n注意：dragstart 與 dragend 事件，在把檔案從作業系統拖放到瀏覽器時，並不會觸發。</code></pre></div>\n<p>drag 文件: <a href=\"https://developer.mozilla.org/zh-TW/docs/Web/API/HTML_Drag_and_Drop_API\" title=\"MDN HTML Drag_and_Drop_API\">MDN HTML Drag_and_Drop_API</a></p>\n<ul>\n<li>MDN drag element demo</li>\n</ul>\n<iframe src=\"//codepen.io/chu1228/embed/mzoXyR/?height=265&theme-id=0&default-tab=result\" width=\"100%\" height=\"250\"></iframe>\n<h3 id=\"外部檔案拖拉\" style=\"position:relative;\"><a href=\"#%E5%A4%96%E9%83%A8%E6%AA%94%E6%A1%88%E6%8B%96%E6%8B%89\" aria-label=\"外部檔案拖拉 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>外部檔案拖拉</h3>\n<p>如果是外部檔案拖拉進的話，依序觸發 dragenter => dragover => drop，這幾個動作要取消預設的事件 event.preventDefault()，防止拖拉開啟檔案。可以用 event.dataTransfer.files 來接受拖拉的檔案。</p>\n<p>下面範例用 FileReader 來轉換檔案成 base64 格式，在打印到 img src 上顯示圖片。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">&lt;</span>div id<span class=\"token operator\">=</span><span class=\"token string\">\"dragZone\"</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>img src<span class=\"token operator\">=</span><span class=\"token string\">\"https://fakeimg.pl/450x100/?text=Drop_your_Image\"</span><span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>div id<span class=\"token operator\">=</span><span class=\"token string\">\"fileText\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>img src<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span> id<span class=\"token operator\">=</span><span class=\"token string\">\"fileImg\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n\n<span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n<span class=\"token keyword\">var</span> dragZone <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dragZone'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> fileText <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fileText'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> fileImg <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fileImg'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// cancel default event</span>\ndragZone<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dragover'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  e<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dragover'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ndragZone<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'drop'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// cancel default event</span>\n  e<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>dataTransfer<span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'僅支援單一檔案'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">var</span> file <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>dataTransfer<span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'image'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'僅支援圖片格式喔'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  fileText<span class=\"token punctuation\">.</span>innerText <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// export file as base64</span>\n  <span class=\"token keyword\">var</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsDataURL</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n     fileImg<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> reader<span class=\"token punctuation\">.</span>result\n   <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span></code></pre></div>\n<iframe src=\"https://codepen.io/chu1228/embed/MPxrdq/?height=265&theme-id=0&default-tab=result\" width=\"100%\" height=\"500\"></iframe>\n<script async src=\"https://static.codepen.io/assets/embed/ei.js\"></script>\n<p>這樣就幾乎完成了。我們只要把上面的 drop 獲取檔案，一起與 ajax 呼叫，就支援拖拉上傳檔案了。</p>\n<p>首先增加包覆的 div，隱藏掉傳統的 input 按鈕，讓外層的區塊點擊觸發點擊 input。再增加上事件監聽，主要依靠 drop 監聽，當獲取檔案時，調用 ajax 傳輸資料。</p>\n<ul>\n<li>修改先前檔案</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token comment\">// add container zone and hide input</span>\n  <span class=\"token operator\">&lt;</span>div id<span class=\"token operator\">=</span><span class=\"token string\">\"dragZone\"</span><span class=\"token operator\">></span>\n    拖拉上傳 Drop Upload\n    <span class=\"token operator\">&lt;</span>input type<span class=\"token operator\">=</span><span class=\"token string\">\"file\"</span> accept<span class=\"token operator\">=</span><span class=\"token string\">\"image/*\"</span> id<span class=\"token operator\">=</span><span class=\"token string\">\"imageUpload\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>progress id<span class=\"token operator\">=</span><span class=\"token string\">\"progress\"</span> style<span class=\"token operator\">=</span><span class=\"token string\">\"display:none\"</span> value<span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> max<span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>progress<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n<span class=\"token operator\">...</span>\n<span class=\"token keyword\">var</span> dragZone <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dragZone'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// add listener click dropzone trigger click input</span>\ndragZone<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'imageUpload'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\ndragZone<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dragover'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  e<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ndragZone<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'drop'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n<span class=\"token operator\">...</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'image'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'僅支援圖片格式喔'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n     <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// get file call ajax</span>\n  <span class=\"token function\">upload</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"頁面完成\" style=\"position:relative;\"><a href=\"#%E9%A0%81%E9%9D%A2%E5%AE%8C%E6%88%90\" aria-label=\"頁面完成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>頁面完成</h2>\n<p><a href=\"https://test.ianccy.com/imgur/\" title=\"Drop file demo\">Drop file demo</a></p>\n<iframe src=\"https://test.ianccy.com/imgur/\" width=\"100%\" height=\"500\"></iframe>\n<p>成功!!這樣就完成拖拉上傳了。</p>\n<p>實際寫一遍會發現其實並沒有太艱難，只是有滿多小細節要處理，包含拖拉事件、串接 api 檔案格式、進度條處理等等。這邊還沒寫邏輯還有圖片寬度高度、size 判斷等等。但擔心繼續寫下去會太長，等下一篇再來處理這些小細節吧。</p>\n<!--- ![dragupload](../images/dragupload.png \"dragupload\") --->\n","fields":{"readingTime":{"text":"9 min read"}},"frontmatter":{"title":"Upload progress bar drag&drop 圖片拖拉上傳進度條","date":"October 27, 2018","description":"首先申請imgur api，再處理input獲取檔案，獲取後串接api，另外針對拖拉要處理事件，要利用dataTransfer獲取檔案，再串接到api，另外針對ajax監聽，製作出進度條。","categories":"javascript","tags":["javascript"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/779e17215a7282b0a75020b8f77faf25/1586c/dragupload.png","srcSet":"/static/779e17215a7282b0a75020b8f77faf25/37fa8/dragupload.png 200w,\n/static/779e17215a7282b0a75020b8f77faf25/6dc05/dragupload.png 400w,\n/static/779e17215a7282b0a75020b8f77faf25/1586c/dragupload.png 800w","sizes":"(min-width: 800px) 800px, 100vw"},"sources":[{"srcSet":"/static/779e17215a7282b0a75020b8f77faf25/1dc03/dragupload.webp 200w,\n/static/779e17215a7282b0a75020b8f77faf25/bc949/dragupload.webp 400w,\n/static/779e17215a7282b0a75020b8f77faf25/4eb70/dragupload.webp 800w","type":"image/webp","sizes":"(min-width: 800px) 800px, 100vw"}]},"width":1280,"height":836.8000000000001}}},"image":{"publicURL":"/static/779e17215a7282b0a75020b8f77faf25/dragupload.png"}},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E7%94%B3%E8%AB%8B-imgur-api-key\">申請 imgur api key</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%82%B3%E7%B5%B1-input-%E4%B8%8A%E5%82%B3\">傳統 input 上傳</a></p>\n</li>\n<li>\n<p><a href=\"#%E4%B8%8A%E5%82%B3%E6%AA%94%E6%A1%88-progress-bar\">上傳檔案 progress bar</a></p>\n</li>\n<li>\n<p><a href=\"#%E6%8B%96%E6%8B%89%E4%B8%8A%E5%82%B3%E6%AA%94%E6%A1%88\">拖拉上傳檔案</a></p>\n<ul>\n<li><a href=\"#%E5%A4%96%E9%83%A8%E6%AA%94%E6%A1%88%E6%8B%96%E6%8B%89\">外部檔案拖拉</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E9%A0%81%E9%9D%A2%E5%AE%8C%E6%88%90\">頁面完成</a></p>\n</li>\n</ul>"},"previous":{"fields":{"slug":"/2018-11-reactportal/"},"frontmatter":{"title":"React Portals render component anywhere example"}},"next":{"fields":{"slug":"/2018-10-tagteach/"},"frontmatter":{"title":"Google Tag Manager(gtm)教學 觸發、代碼、變數設定介紹"}}},"pageContext":{"id":"670aa326-aa76-598f-b15c-d5188724554a","previousPostId":"27b0f134-0874-5992-8ce1-e14222a0f585","nextPostId":"7d808c6e-f4c6-5c3c-9c60-255b457951d1"}},"staticQueryHashes":["3649515864","3707347541","3761976949"],"slicesMap":{}}