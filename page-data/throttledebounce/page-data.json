{"componentChunkName":"component---src-templates-post-tsx","path":"/throttledebounce/","result":{"data":{"site":{"siteMetadata":{"title":"Ian Chu"}},"markdownRemark":{"id":"0166a81f-3837-518b-a533-8c1cb0a9e93f","excerpt":"假設一個 autocomplete 的需求， input 輸入框，需要在輸入字串的時候，更新下拉選單選項，類似 google search input 的建議，另外狀況是 auto search 的功能，當使用者邊在 input…","html":"<p>假設一個 autocomplete 的需求， input 輸入框，需要在輸入字串的時候，更新下拉選單選項，類似 google search input 的建議，另外狀況是 auto search 的功能，當使用者邊在 input 輸入字串的時候，就一邊會自動送出查詢的功能，這兩者功能如果都沒特別處理，不意外的話，很快就會出意外了。</p>\n<h2 id=\"發生什麼問題\" style=\"position:relative;\"><a href=\"#%E7%99%BC%E7%94%9F%E4%BB%80%E9%BA%BC%E5%95%8F%E9%A1%8C\" aria-label=\"發生什麼問題 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>發生什麼問題</h2>\n<p>我們就來解釋一下可能發生的問題，這兩者需求都有相同狀態是，短時間內對同一隻 api 快速發出請求，我們就以 auto search 為例子，假設有使用者要嘗試搜尋 banana，那在前面邊打字的時候就會送出 api 請求，假設這之間剛好觸發送出了三次，但是如果 api <code class=\"language-text\">/query?name=ba</code> 的 response 最晚回來，</p>\n<p>至於 api 為什麼會這樣，也可能 database 模糊比對的結果比較多，回傳比較慢之類的，啊就不深究問題了。</p>\n<p>這就會導致搜尋結果可能會有 barbapapa 之類的怪東西，就被使用者抱怨，啊這東西搜尋怎跟我想要的不一樣。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin: 2vw 0;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0977aa9f95525194ec52dc7e4994b711/a45af/barbapapa.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 72%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsTAAALEwEAmpwYAAADXklEQVR42hXCa0wbBRwA8P9dU1snDjbICBAThn6YcXGRRZ3LCAG8lbZZQTQu+1S3tVyP3pW1UDbUMRIfH1xcNodPBJwwKn3cq9dHhtEPGEzW9p4tZcvINtrNZRqNhmQbDM/4yw8kNigxJ3K0L0OTmQiRCfdlwkQ25MnE8CzrykZdOcYjRkgxTOWZgEwP5vmhPDNU5E+tpM6AHB+QOEpmSJnx5iK4GMalOVykPdJFonTso9+dX6yMjoph4roQGDvpeL6u+kK/ffXK8BIXvJUeATU+IHOkwv5fjHqyYTwb8/xy3lnCPlnDQnorq7fG7xLn8kwfub9pJ0D3MzWLU8SN1PBK6jRoiYDCkQpHyhwpxfpyYU+OdYkjg9dG+MJYcsMa2eikdUxIHgnW1NY3Nh0AMHbu33UjcfJm+j1QhQGF8ykcpfCURBNS1CPyxwsfnyp6f1h1za3bo48sMR3j+O6xniMDp4cuN9Q2bjEZfp0hyz++D/lEQIv3KyylspRC43K0V2Ld6kTfmmXy3/boQyz0yELr9nn+lWBF1ZP1NdUAUF1Zocb8t+ffhUJyUIv7VJ7SeEqlcSXq0mK4xB6/g5/dbGfWbfRja3Ldxm908j07XgUAFBAjip4POv5a/BAKiUEtTmlxr8oTMu2WaLcaw7W06/qnQ5sYv2nnH1ojGx2MfmjhastFA4KgCCAABhQNOjugkApqAqUJ3nzSpwmUyvbKbK8aItQPyAf2uccW5p+2yQW7f+3Q9MQLFAAgiOHl7aZ6MwIAUEgFCglSjfuy029lL3VLYUJOuQujgXutY2u2kG67stDu91p2CFZXW9VuANi7zfTzG81vP1f77C4LFJJ+TTiRn7VK33aJ4w5pfJ/MEArtvvPOWb1DWO2amjzcI5vQ9PY6M2KoeHrrN0cdi/029rXK9te/gqV0UGXJW5fqy8yB4mXrta8r5dmjcuLYTf8ZHZtf3ufLNTX9gRhLCNIMyNYKs9C1d8nZLGN1DbsjoMQIaebw/Vnz3SmkeMG4/PkWeaZbniP+fnNct/5Uami5DVBG0TKKtqIIAPLdi0bdAV+2tKF7cnB13C5/tvPPiOH+rOFeyPjbNCx/36ido9Y7Q+LB4aWnqsoAJQQpAzjNhpbaJ4qY6UEXqAe37Xlp4j8M0auqhQ9K3QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/0977aa9f95525194ec52dc7e4994b711/7cd9b/barbapapa.webp 400w\"\n              sizes=\"(max-width: 400px) 100vw, 400px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/0977aa9f95525194ec52dc7e4994b711/a45af/barbapapa.png 400w\"\n            sizes=\"(max-width: 400px) 100vw, 400px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/0977aa9f95525194ec52dc7e4994b711/a45af/barbapapa.png\"\n            alt=\"無辜的 barbapapa\"\n            title=\"無辜的 barbapapa\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">無辜的 barbapapa</figcaption>\n  </figure></p>\n<ul>\n<li>問題發生流程</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// input 輸入 `ba`</span>\nfetch <span class=\"token operator\">/</span>query<span class=\"token operator\">?</span>name<span class=\"token operator\">=</span>ba\n\n<span class=\"token comment\">// input 輸入 `bana`</span>\nfetch <span class=\"token operator\">/</span>query<span class=\"token operator\">?</span>name<span class=\"token operator\">=</span>bana\n\n<span class=\"token comment\">// input 輸入 `banana`</span>\nfetch <span class=\"token operator\">/</span>query<span class=\"token operator\">?</span>name<span class=\"token operator\">=</span>banana</code></pre></div>\n<h2 id=\"解決-api-response-相互覆蓋問題\" style=\"position:relative;\"><a href=\"#%E8%A7%A3%E6%B1%BA-api-response-%E7%9B%B8%E4%BA%92%E8%A6%86%E8%93%8B%E5%95%8F%E9%A1%8C\" aria-label=\"解決 api response 相互覆蓋問題 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>解決 api response 相互覆蓋問題</h2>\n<p>講了問題當然就要來討論怎麼解決這些問題，有幾種做法，可以處理掉。</p>\n<p>第一種可以取消上一個 api request，fetch、axois 或是 xhrHttpRequest 都可以收回請求，同一隻 api 每次有新的請求，都嘗試去 cancel last request。</p>\n<p>第二種就是利用 debounce，讓 api 請求不要頻率這麼的高，debounce 可以設定一定時間內，當有新的 update 進來後，都延長 query 的計時，聽起來有點不知道說啥。</p>\n<p>下方是模擬剛剛 input 輸入 banana 搭配 debounce。</p>\n<ul>\n<li>debounce</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// setting debounce callback 1 sec</span>\n\n<span class=\"token operator\">|</span> o<span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span> <span class=\"token number\">0.6</span> sec\n<span class=\"token comment\">// 輸入 ba</span>\n<span class=\"token comment\">// 計時一秒後送出查詢</span>\n                   o <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span> <span class=\"token number\">0.5</span> sec\n                   <span class=\"token comment\">// 0.6 秒後持續輸入 na</span>\n                   <span class=\"token comment\">// 再度延長計時一秒</span>\n                                    o <span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">--</span><span class=\"token operator\">-</span> <span class=\"token operator\">|</span>\n                                    <span class=\"token comment\">// 0.5 秒後持續輸入 na</span>\n                                    <span class=\"token comment\">// ( 完成輸入 banana)</span>\n                                    <span class=\"token comment\">// 再度延長計時一秒</span>\n                                                        <span class=\"token comment\">//  一秒後送出查詢！</span></code></pre></div>\n<p>至於用哪種方法是沒有絕對對錯，也可以都處理，兩者都有各自適合的場景，api cancel 可能會因為使用者打到一半，api 又剛好回傳很快，然後讓頁面有不必要的更新，debounce 就需要時間等待 callback，如果需求不予許等待時間，那就前者做法好一點，那這邊就先不要浪費太多時間去深究各自問題了。</p>\n<p>然後如果有其他方法歡迎留言跟我說，感恩。</p>\n<h2 id=\"實現-debounce\" style=\"position:relative;\"><a href=\"#%E5%AF%A6%E7%8F%BE-debounce\" aria-label=\"實現 debounce permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>實現 debounce</h2>\n<p>秉持著 javascript 沒有黑魔法， <del>某些特性真的可能有</del>，接下來就來嘗試寫一個 dobounce 吧。</p>\n<h3 id=\"debounce-的功能\" style=\"position:relative;\"><a href=\"#debounce-%E7%9A%84%E5%8A%9F%E8%83%BD\" aria-label=\"debounce 的功能 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>debounce 的功能</h3>\n<p>一個 debounce 會有兩個參數，第一個會是需要執行的 function，並且可以讓我們帶入參數，第二個就是多久的時間，要執行 callback，然後會再回傳一個 function，讓我們後面可以直接調用。</p>\n<ul>\n<li>使用範例</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> debounceSearch <span class=\"token operator\">=</span> <span class=\"token function\">debounce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">queryStr</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">https://jsonplaceholder.typicode.com/todos/1?</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>queryStr<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">handleSearch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">queryStr</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">debounceSearch</span><span class=\"token punctuation\">(</span>queryStr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"開始實現-debounce\" style=\"position:relative;\"><a href=\"#%E9%96%8B%E5%A7%8B%E5%AF%A6%E7%8F%BE-debounce\" aria-label=\"開始實現 debounce permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>開始實現 debounce</h3>\n<p>首先思考的是，這個時間，我們要怎麼透過每一次 callback 後，都延長計時，很直覺想到就是用 setTimeout，這也是 javascript 僅能用的 timer，大概思路就是 set 一個 timer，如果今天有再度被調用的話，就 clear timer，重新再來計時一次，於是，我們就這樣就解決了最魔法的部分了，</p>\n<ul>\n<li>handle time</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">debounce</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">x<span class=\"token punctuation\">,</span> time</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> timer <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>timer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>接下來就是處理 callback function 的部分，這邊比較麻煩應該就是要怎麼傳遞參數進去，就直接利用 return function，再透過這邊帶入參數。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">debounce</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> time</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>我們就快大功告成了，算是完成核心兩個 input callback 以及 time 的部分，剩下就要處理 clearTimer 的時機點。</p>\n<p>首先一定要在執行 callback 的時候順便 clearTimer，所以勢必得塞進去 return function 執行緒裡面，那比較困擾的是，要怎樣才能清除上一個 timer，答案就是依賴 closure。</p>\n<p>我們先建立一個變數 memoryTimer，寫在外層讓他的記憶體位置一直被保留著，並在執行過一次 callback 後，就讓它 reassign 成為 timer， <code class=\"language-text\">let memoryTimer;</code> 代表會是 undefined falsely condition，那執行過後再判斷是否為 true，如果為 true 就把 timer 清除掉，就可以收回上一個 setTimeout 了。</p>\n<ul>\n<li>完成 debounce</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">debounce</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> time</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// closure will let memoryTimer memory position</span>\n    <span class=\"token keyword\">let</span> memoryTimer<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>memoryTimer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token function\">clearTimeout</span><span class=\"token punctuation\">(</span>timer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        memoryTimer <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"實現-throttle\" style=\"position:relative;\"><a href=\"#%E5%AF%A6%E7%8F%BE-throttle\" aria-label=\"實現 throttle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>實現 throttle</h2>\n<p>都已經完成 debounce 了，就來順手寫一下它的好兄弟 throttle 吧 XDD。throttle 被稱之為節流閥，在指定的時間內，只能被一次性的 callback，像是保護 callback 在一定時間內只允許執行一次。</p>\n<h3 id=\"throttle-的功能\" style=\"position:relative;\"><a href=\"#throttle-%E7%9A%84%E5%8A%9F%E8%83%BD\" aria-label=\"throttle 的功能 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>throttle 的功能</h3>\n<p>首先在指定的時間內，只能被一次性的 callback，這個 callback 還是由第一個觸發的所執行的。也跟 debounce 一樣有兩個 input，callback function 以及 time，還有需要回傳 function 讓後續使用。</p>\n<h3 id=\"開始實現-throttle\" style=\"position:relative;\"><a href=\"#%E9%96%8B%E5%A7%8B%E5%AF%A6%E7%8F%BE-throttle\" aria-label=\"開始實現 throttle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>開始實現 throttle</h3>\n<p>一樣先想一下 throttle 的功能，聽起來跟 debounce 87% 像，就只要注意要怎樣在時間內卡住 callback 不要再被執行。</p>\n<p>就反向思考 debounce 來看，debounce 是不斷延長 timer，throttle 反而是依賴 timer，卡住新的 callback，於是我們就一樣看 timer 有沒有存在，存在就完全不做事情，於是就把 condition 換成 <code class=\"language-text\">if(!memoryTimer){</code> 來執行 setTimeout。</p>\n<p>這邊我是直接 copy paste debounce code，就不贅述 input 那些細節了，邏輯都是一樣的。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">throttle</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> time</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// closure will let memoryTimer memory position</span>\n    <span class=\"token keyword\">let</span> memoryTimer<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>memoryTimer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            memoryTimer <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>但這邊就會發現另一個問題了，<code class=\"language-text\">memoryTimer</code> 在 setTimeout 執行完之後，還是依舊會是 timer，就會導致直接卡死沒辦法繼續執行，那就想辦法讓<code class=\"language-text\">memoryTimer</code> 可以再度變成 falsely 的狀態，就可以再度重複使用了。</p>\n<p>ps. 這邊我原本是寫 <code class=\"language-text\">clearTimeout(memoryTimer);</code> ，以為可以就這樣讓 <code class=\"language-text\">memoryTimer</code> 變成 falsely，結果是無法，他依舊會是一個 timer。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">throttle</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">callback<span class=\"token punctuation\">,</span> time</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// closure will let memoryTimer memory position</span>\n    <span class=\"token keyword\">let</span> memoryTimer<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>memoryTimer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            memoryTimer <span class=\"token operator\">=</span> <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                memoryTimer <span class=\"token operator\">=</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"心得\" style=\"position:relative;\"><a href=\"#%E5%BF%83%E5%BE%97\" aria-label=\"心得 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>心得</h2>\n<p>以下心得都跟 debounce throttle 無關，純屬個人 murmur。</p>\n<p>這篇文章其實是很久很久以前寫到一半的，今天才一口氣補完的。因緣際會在某個面試場合，被面試官稱讚 blog 內容，鼓勵我可以繼續寫文章，說實在當下滿感人的，對方還提出滿多篇內容跟我討論研究，還給我一些更多的解法，真痛哭流涕。</p>\n<p>工作了幾年之後，反而會浮出一種心態是，<code class=\"language-text\">這東西不是很簡單嗎？為什麼要特別寫一篇文章。</code>最近反而開始想不到主題來寫文章了，然後長時間沒有寫作反而讓表達能力下降不少，我自己又有一個老毛病，就是講話很喜歡省字跳來跳過，還是希望透過寫作改善這個問題。</p>\n<p>雖然剛剛說東西簡單嗎，但剛剛實現 throttle 還寫錯卡了一下 XDD。</p>\n<p>最後就期待自己之後可以用更口語簡單的方式，介紹一些實用的技術。</p>","fields":{"readingTime":{"text":"10 min read"}},"frontmatter":{"title":"Throttle and Debounce. 使用場景與嘗試實現它們","date":"February 17, 2023","description":"debounce 可以解決掉短時間內快速 callback 的問題，能夠讓我們指定時間，並且在這時間經由每次重複調用去延長 callback 執行時間。最後我們會手刻一個 debounce 跟 throttle。","categories":"javascript","tags":["javascript"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/df854c0457f886d49a0a47bc61913d79/d43e2/throttle_debounce.png","srcSet":"/static/df854c0457f886d49a0a47bc61913d79/b80f3/throttle_debounce.png 320w,\n/static/df854c0457f886d49a0a47bc61913d79/d408f/throttle_debounce.png 640w,\n/static/df854c0457f886d49a0a47bc61913d79/d43e2/throttle_debounce.png 1280w","sizes":"(min-width: 1280px) 1280px, 100vw"},"sources":[{"srcSet":"/static/df854c0457f886d49a0a47bc61913d79/aeec2/throttle_debounce.webp 320w,\n/static/df854c0457f886d49a0a47bc61913d79/13dc1/throttle_debounce.webp 640w,\n/static/df854c0457f886d49a0a47bc61913d79/b8886/throttle_debounce.webp 1280w","type":"image/webp","sizes":"(min-width: 1280px) 1280px, 100vw"}]},"width":1280,"height":638.0000000000001}}},"image":{"publicURL":"/static/df854c0457f886d49a0a47bc61913d79/throttle_debounce.png"}},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%E7%99%BC%E7%94%9F%E4%BB%80%E9%BA%BC%E5%95%8F%E9%A1%8C\">發生什麼問題</a></p>\n</li>\n<li>\n<p><a href=\"#%E8%A7%A3%E6%B1%BA-api-response-%E7%9B%B8%E4%BA%92%E8%A6%86%E8%93%8B%E5%95%8F%E9%A1%8C\">解決 api response 相互覆蓋問題</a></p>\n</li>\n<li>\n<p><a href=\"#%E5%AF%A6%E7%8F%BE-debounce\">實現 debounce</a></p>\n<ul>\n<li><a href=\"#debounce-%E7%9A%84%E5%8A%9F%E8%83%BD\">debounce 的功能</a></li>\n<li><a href=\"#%E9%96%8B%E5%A7%8B%E5%AF%A6%E7%8F%BE-debounce\">開始實現 debounce</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E5%AF%A6%E7%8F%BE-throttle\">實現 throttle</a></p>\n<ul>\n<li><a href=\"#throttle-%E7%9A%84%E5%8A%9F%E8%83%BD\">throttle 的功能</a></li>\n<li><a href=\"#%E9%96%8B%E5%A7%8B%E5%AF%A6%E7%8F%BE-throttle\">開始實現 throttle</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E5%BF%83%E5%BE%97\">心得</a></p>\n</li>\n</ul>"},"previous":{"fields":{"slug":"/2023-04-abortcontroller/"},"frontmatter":{"title":"AbortController in React, cancel in function call"}},"next":{"fields":{"slug":"/2022-08-useeffectintro/"},"frontmatter":{"title":"Rediscover useEffect and when to use it"}}},"pageContext":{"id":"0166a81f-3837-518b-a533-8c1cb0a9e93f","previousPostId":"f12e6f17-9198-5610-9003-1a2eb2531122","nextPostId":"840e9b57-2a64-5dcc-8c74-c067ee80d54f"}},"staticQueryHashes":["3649515864","3707347541","3761976949"],"slicesMap":{}}