{"componentChunkName":"component---src-templates-post-tsx","path":"/cssperformance/","result":{"data":{"site":{"siteMetadata":{"title":"Ian Chu"}},"markdownRemark":{"id":"06a6f953-f9ec-5160-89cf-ebea00861edc","excerpt":"CSS 常被認為簡單好學，我對它看法是易學但難精通，以前都只想過實現各種 UI、效果，但沒認真考慮過效能，怎樣的寫法最適合這個情境。假設你有針對 google page speed、lighthouse…","html":"<p>CSS 常被認為簡單好學，我對它看法是易學但難精通，以前都只想過實現各種 UI、效果，但沒認真考慮過效能，怎樣的寫法最適合這個情境。假設你有針對 google page speed、lighthouse 優化過，應該會特別有感觸，該如何才能讓網頁載入更快。</p>\n<p>接下來討論如何讓畫面渲染載入更快，以及一些最佳化使用方式。</p>\n<h2 id=\"網頁渲染邏輯\" style=\"position:relative;\"><a href=\"#%E7%B6%B2%E9%A0%81%E6%B8%B2%E6%9F%93%E9%82%8F%E8%BC%AF\" aria-label=\"網頁渲染邏輯 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>網頁渲染邏輯</h2>\n<p>首先介紹最基礎的 painting，瀏覽器的畫面產生，需要有幾個步驟，先是由上至下掃一遍 html，擷取內容後，先產生 HTML DOM tree，再來產生 CSSOM tree，</p>\n<p>經由上面步驟，轉譯樹狀結構，將 兩個 tree 合併起來產生 render tree，最後是關鍵的步驟，根據每個節點，依照 style 決定 layout 版面配置，或是決定樣式套用，並且繪製在畫面上，就是我們看到 div 並帶有 width 等樣式。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin: 2vw 0;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1980px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dabcb77dd3ee413933fbd9d47f1cca92/279cc/domcssom.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.8989898989899%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFUlEQVQ4y5WT2a6DMAxE8/9fyQsIEIh9X1wdS67S3Oa2jWQlxM54xjZOROS+b7E9NP/+UyzmwsDruqQoCpmm6c9DW3Y+z1PSNJWmaZ73LgTb913GcZRt2/TbXz4wvuM4pOs6mef5GfvCEFZ936tzGAap61qWZVGzBxbPHczWddU3qIKxs2wwwsluwGRu21aN4JAlapIk0cRgYI5Low0YWTn/t3zZvLFkKhlWJovaAQY7n5HVCwubGNbXfcOElee5lGX5cbxcbJ78IOsihpJYUpX8biTCztNxysGZerNj1D8EdWGmdwWHYVVV+k0dbSI4RwF9B8GMCmxgx06jDOBnyQxplmX6W9EMEsAw9jt+JTnGJOY3wAdaSk96KyAb7AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/dabcb77dd3ee413933fbd9d47f1cca92/a805d/domcssom.webp 495w,\n/static/dabcb77dd3ee413933fbd9d47f1cca92/36741/domcssom.webp 990w,\n/static/dabcb77dd3ee413933fbd9d47f1cca92/41a9f/domcssom.webp 1980w,\n/static/dabcb77dd3ee413933fbd9d47f1cca92/586d9/domcssom.webp 2281w\"\n              sizes=\"(max-width: 1980px) 100vw, 1980px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/dabcb77dd3ee413933fbd9d47f1cca92/b3db0/domcssom.png 495w,\n/static/dabcb77dd3ee413933fbd9d47f1cca92/8ddfd/domcssom.png 990w,\n/static/dabcb77dd3ee413933fbd9d47f1cca92/7c078/domcssom.png 1980w,\n/static/dabcb77dd3ee413933fbd9d47f1cca92/279cc/domcssom.png 2281w\"\n            sizes=\"(max-width: 1980px) 100vw, 1980px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/dabcb77dd3ee413933fbd9d47f1cca92/7c078/domcssom.png\"\n            alt=\"html DOM CSSOM\"\n            title=\"HTMLDOM CSSOM Render Tree (畫圖花了我三十分鐘...)\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">HTMLDOM CSSOM Render Tree (畫圖花了我三十分鐘...)</figcaption>\n  </figure></p>\n<p>Google: <a href=\"https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-tree-construction?hl=zh-tw\" title=\"轉譯樹狀結構的建構、版面配置和繪製\">轉譯樹狀結構的建構、版面配置和繪製</a></p>\n<p>所謂的優化關鍵路徑，就是要縮短這整個流程的時間，擷取 HTML -> DOM tree -> CSSOM tree -> render tree -> painting。</p>\n<h2 id=\"避免使用影響載入\" style=\"position:relative;\"><a href=\"#%E9%81%BF%E5%85%8D%E4%BD%BF%E7%94%A8%E5%BD%B1%E9%9F%BF%E8%BC%89%E5%85%A5\" aria-label=\"避免使用影響載入 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>避免使用影響載入</h2>\n<p>網頁載入速度快慢影響，首先是資源請求速度，網頁上的 CSS JS file 都會是需要發 http 請求的，遇到這狀況時，解析器都必須先停止解析 HTML 並執行該腳本，然後才能繼續解析。所以盡可能避免過多個資源請求，讓 css 或是 js print 到 html 上。</p>\n<p>針對 script file 推薦用 async 或是 defer，async 是不中斷 HTML parser 並當載入 js file 完成立刻執行，defer 則是當整體 HTML parser 完成，再回頭執行 js file。小提醒 async 代表在這邊操作 DOM 都是可能失敗的，因為你無法預知載入 file 時，DOM 有無產生。</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"margin: 2vw 0;\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1980px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/95a6b3387d845aa5ebd60c9af8622f25/e5937/asyncdefer.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.242424242424242%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAABBElEQVQY0zWQ7W7DIAxF8/4Pt9/buo9u60pJSQghEDCUMwVplo4sWfK99h201oQQaO3ROWr1DnVTtNYoNZFLoNTItgcm13ArlCUgmyXXSN4dRfa+O3x/n/m5fHWR1iqPVjDzyPvHCZFEyDMu3vBJM28aNZuODxMhadyu2ewPEh2P9mDQWqFuV2Zr2FPsLmYaeT29UIoQZcGnO0EMkzd8qIMbl/OVcVSsMhGW3y54fDScvz45OL29clxr7cTd6D47BLc0swSN3zWzH7mYO9fZ8PRueH5TpOUX7xQisUc2lFL5p9ajF0QyIcTu6IPFuhVv7/iwkouQRYg5IzlBraybJUnqGf4B7+x+9nctLYIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/95a6b3387d845aa5ebd60c9af8622f25/a805d/asyncdefer.webp 495w,\n/static/95a6b3387d845aa5ebd60c9af8622f25/36741/asyncdefer.webp 990w,\n/static/95a6b3387d845aa5ebd60c9af8622f25/41a9f/asyncdefer.webp 1980w,\n/static/95a6b3387d845aa5ebd60c9af8622f25/0cf63/asyncdefer.webp 2062w\"\n              sizes=\"(max-width: 1980px) 100vw, 1980px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/95a6b3387d845aa5ebd60c9af8622f25/b3db0/asyncdefer.png 495w,\n/static/95a6b3387d845aa5ebd60c9af8622f25/8ddfd/asyncdefer.png 990w,\n/static/95a6b3387d845aa5ebd60c9af8622f25/7c078/asyncdefer.png 1980w,\n/static/95a6b3387d845aa5ebd60c9af8622f25/e5937/asyncdefer.png 2062w\"\n            sizes=\"(max-width: 1980px) 100vw, 1980px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/95a6b3387d845aa5ebd60c9af8622f25/7c078/asyncdefer.png\"\n            alt=\"async defer\"\n            title=\"script async defer\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">script async defer</figcaption>\n  </figure></p>\n<p>神圖介紹來源: <a href=\"https://html.spec.whatwg.org/multipage/scripting.html\" title=\"whatwg製\">whatwg</a></p>\n<p>同時假設在 HTML parser 階段就開始執行 javascript，都會中斷 HTML parser 的，所以這邊要盡量避免在初始化執行大量 javascript，可以用事件監聽 DOM loaded 觸發執行。</p>\n<p>另外就是 CSS import font，實務上常常是這點卡住，這建議用 javascript 非同步方式載入，ps. 我們用過這方法大概推進 lighthouse 20 分左右。</p>\n<p>至於 http 2，目前還有滿多 cdn 尚未支援的，這邊就不多討論，大概概念就是這可以大幅加快 http 請求速度，實現同時多個 http 請求，並且不阻塞。</p>\n<p>最後假設 SPA 是純 client side render 又要追求載入速度的話，直接起跑點就輸了，比較建議考慮直接改 server side render，你用上面邏輯跑一遍，就大概知道這是 飛機 vs 機車的差距了。</p>\n<h2 id=\"心得\" style=\"position:relative;\"><a href=\"#%E5%BF%83%E5%BE%97\" aria-label=\"心得 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>心得</h2>\n<p>我自己是覺得原理滿重要的，當初在學習前端時候，常常只是無腦跟著教學走，只是覺得瀏覽器真神奇，各種炫砲畫面，假設知道原理後，就更容易知道問題在哪裏，其實我原本是想寫 CSS animation 的，沒想到研究研究就覺得這應該也滿重要的，就先寫這篇了。</p>\n<p>下方內容滿推薦的，真心推薦前端都需要看過一遍，會對於效能這件事，有更深的了解。</p>\n<p>google 教學: <a href=\"https://developers.google.com/web/fundamentals/performance/critical-rendering-path\" title=\"網頁渲染運作邏輯\">網頁渲染運作邏輯</a></p>\n<p>一樣感謝閱讀，有問題歡迎留言</p>","fields":{"readingTime":{"text":"5 min read"}},"frontmatter":{"title":"Critical Rendering Path 關鍵渲染路徑優化","date":"February 11, 2021","description":"假設你有針對 google page speed、lighthouse 優化過，應該會特別有感觸，該如何才能讓網頁載入更快。接下來討論如何讓畫面渲染載入更快，以及一些最佳化使用方式。","categories":"javascript","tags":["css"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f88848","images":{"fallback":{"src":"/static/9544917ac4a00b8c626e23163748bef2/87b84/paintings.jpg","srcSet":"/static/9544917ac4a00b8c626e23163748bef2/1ef09/paintings.jpg 220w,\n/static/9544917ac4a00b8c626e23163748bef2/4282e/paintings.jpg 441w,\n/static/9544917ac4a00b8c626e23163748bef2/87b84/paintings.jpg 881w","sizes":"(min-width: 881px) 881px, 100vw"},"sources":[{"srcSet":"/static/9544917ac4a00b8c626e23163748bef2/1b9e4/paintings.webp 220w,\n/static/9544917ac4a00b8c626e23163748bef2/aad5a/paintings.webp 441w,\n/static/9544917ac4a00b8c626e23163748bef2/75a1e/paintings.webp 881w","type":"image/webp","sizes":"(min-width: 881px) 881px, 100vw"}]},"width":1280,"height":666.8785471055619}}},"image":{"publicURL":"/static/9544917ac4a00b8c626e23163748bef2/paintings.png"}}},"previous":{"fields":{"slug":"/2020-12-thirtyyearsold/"},"frontmatter":{"title":"30 歲的我"}},"next":{"fields":{"slug":"/2021-05-cssanimation/"},"frontmatter":{"title":"CSS animation Performance"}}},"pageContext":{"id":"06a6f953-f9ec-5160-89cf-ebea00861edc","previousPostId":"3f51052f-e468-5a30-a755-3e9911885298","nextPostId":"e20c6779-3974-5700-9211-6a3f4a1f0139"}},"staticQueryHashes":["3649515864","3761976949","441988385"]}