{"componentChunkName":"component---src-templates-post-tsx","path":"/postmessage/","result":{"data":{"site":{"siteMetadata":{"title":"Ian Chu"}},"markdownRemark":{"id":"e7bf03c7-c427-580a-b032-94e06f4499fd","excerpt":"最近在公司專案學到了滿好用的功能 postMessage，當今天使用到跨視窗 iframe 或是 openWindow，原本 parent 頁面需要傳遞訊息給內頁 iframe 或是 tab 頁，就可以利用 postMessage 來傳遞資料。接下來會建立 demo 頁面，介紹一下 iframe 跟 window…","html":"<p>最近在公司專案學到了滿好用的功能 postMessage，當今天使用到跨視窗 iframe 或是 openWindow，原本 parent 頁面需要傳遞訊息給內頁 iframe 或是 tab 頁，就可以利用 postMessage 來傳遞資料。接下來會建立 demo 頁面，介紹一下 iframe 跟 window open 的使用方法。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">window<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> 方法被調用時，會在所有頁面腳本執行完畢之後\n（e<span class=\"token punctuation\">.</span>g<span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> 在該方法之後設置的事件、之前設置的timeout 事件<span class=\"token punctuation\">,</span>etc<span class=\"token punctuation\">.</span>）\n向目標窗口派發一個  MessageEvent 消息。\n\n該MessageEvent消息有四個屬性需要注意：\nmessage 屬性表示該message 的類型；\ndata 屬性為 window<span class=\"token punctuation\">.</span>postMessage 的第一個參數；\norigin 屬性表示調用 window<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> 方法時調用頁面的當前狀態；\nsource 屬性記錄調用 window<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> 方法的窗口信息。</code></pre></div>\n<h2>window postMessage 介紹</h2>\n<p>postMessage 的調用方式 => targetWindow.postMessage(message, targetOrigin, [transfer])，targetWindow 會是某個窗口，targetOrigin 則是指定可傳遞的端口網域，transfer 是一串和 message 同時傳遞的 Transferable 對象。</p>\n<p>targetWindow 可設定目標 :</p>\n<ul>\n<li>Window.open</li>\n<li>Window.opener</li>\n<li>HTMLIFrameElement.contentWindow (embedded iframe ),</li>\n<li>Window.parent ( parent window embedded iframe)</li>\n<li>Window.frames + an index value (named or numeric).</li>\n</ul>\n<p><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage#Syntax\" title=\"window postMessage MDN\">window postMessage MDN </a></p>\n<h2>window open demo page</h2>\n<p>首先要建立送出訊息跟接受訊息的頁面，送出訊息頁面主要做兩件事情，開啟視窗並指定為變數、向剛剛開啟視窗頁面送出訊息。javascript 沒有特別難度，所以就直接看我建立好的頁面，底下是處理的 html 還有 javascript。</p>\n<p>範例 :</p>\n<ul>\n<li>使用步驟 先點選開啟視窗</li>\n<li>輸入隨意字串</li>\n<li>點選送出按鈕</li>\n</ul>\n<p>ps.分頁切換需要用瀏覽器 app safari、chrome</p>\n<iframe src=\"https://work.ianccy.com/postmessage/send.html\" width=\"100%\" height=\"300px\" frameborder=\"0\" scrolling=\"no\"></iframe>\n<p>Source : <a href=\"https://work.ianccy.com/postmessage/send.html\" target=\"_blank\">Open Window Demo Page</a></p>\n<p>send.html</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token constant\">DOCTYPE</span> html<span class=\"token operator\">></span>\n<span class=\"token operator\">...</span>\n  <span class=\"token operator\">&lt;</span>h1 <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"cover-heading\"</span><span class=\"token operator\">></span><span class=\"token constant\">HTML</span> send Post Message demo sample<span class=\"token punctuation\">.</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>p <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"lead\"</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>button id<span class=\"token operator\">=</span><span class=\"token string\">\"openWindow\"</span> type<span class=\"token operator\">=</span><span class=\"token string\">\"button\"</span> <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"btn btn-info\"</span><span class=\"token operator\">></span>開啟視窗<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>p<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"input-group\"</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>input type<span class=\"token operator\">=</span><span class=\"token string\">\"text\"</span> id<span class=\"token operator\">=</span><span class=\"token string\">\"messageText\"</span> <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"form-control\"</span> placeholder<span class=\"token operator\">=</span><span class=\"token string\">\"輸入訊息\"</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>div <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"input-group-append\"</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>button id<span class=\"token operator\">=</span><span class=\"token string\">\"postWindow\"</span> <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"btn btn-info btn-outline-secondary\"</span> type<span class=\"token operator\">=</span><span class=\"token string\">\"button\"</span><span class=\"token operator\">></span>送出訊息<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>button<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n<span class=\"token operator\">...</span>\n  <span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n    <span class=\"token comment\">// 建立變數</span>\n    <span class=\"token keyword\">var</span> createWindow<span class=\"token punctuation\">;</span>\n    document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'openWindow'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 將變數 assign window open 物件</span>\n      createWindow <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./receive.html\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'postWindow'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      <span class=\"token function\">sendMsg</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">sendMsg</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">var</span> message <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"messageText\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">var</span> domain <span class=\"token operator\">=</span> window<span class=\"token punctuation\">.</span>location<span class=\"token punctuation\">.</span>origin<span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// post message</span>\n      createWindow<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">,</span> domain<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// focus windowOpen</span>\n      createWindow<span class=\"token punctuation\">.</span><span class=\"token function\">focus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"messageText\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token operator\">...</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>html<span class=\"token operator\">></span></code></pre></div>\n<p>recevie.html</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span><span class=\"token constant\">DOCTYPE</span> html<span class=\"token operator\">></span>\n<span class=\"token operator\">...</span>\n    <span class=\"token operator\">&lt;</span>p <span class=\"token keyword\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"lead\"</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>h2 id<span class=\"token operator\">=</span><span class=\"token string\">\"response\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h2<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>p<span class=\"token operator\">></span>\n<span class=\"token operator\">...</span>\n    <span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n      window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> getMessage<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">function</span> <span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> content <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// e.data 接受傳遞訊息</span>\n        content <span class=\"token operator\">+=</span> <span class=\"token string\">\"Get Message =>\"</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span>data <span class=\"token operator\">+</span> <span class=\"token string\">'&lt;br>'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// e.origin 接受訊息domain</span>\n        content <span class=\"token operator\">+=</span> <span class=\"token string\">\"Url from \"</span> <span class=\"token operator\">+</span> e<span class=\"token punctuation\">.</span>origin<span class=\"token punctuation\">;</span>\n        document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"response\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;p>\"</span> <span class=\"token operator\">+</span> content <span class=\"token operator\">+</span> <span class=\"token string\">\"&lt;/p>\"</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token operator\">...</span>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>html<span class=\"token operator\">></span></code></pre></div>\n<h2>iframe demo page</h2>\n<p>這個會比較特別，window open 是原本頁面傳給開啟頁面，iframe 則會使用 iframe embed 內部的網站傳遞資料給外部 parent，範例情境大概是修正 iframe 的高度，</p>\n<p>範例 : (白色區塊是使用 iframe)</p>\n<ul>\n<li>點選 iframe 內 伸縮高度按鈕</li>\n<li>點擊按鈕後，會變化 body 高度，並傳值到 parent window</li>\n<li>parent window 接受到值後，變化 iframe style height</li>\n</ul>\n<iframe id=\"addIframe\" src=\"https://work.ianccy.com/postmessage/embed.html\" width=\"100%\" height=\"200px\"></iframe>\n<p>Source : <a href=\"https://work.ianccy.com/postmessage/iframe.html\" target=\"_blank\">Iframe Demo Page</a></p>\n<p>iframe.html</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">...</span>\n  <span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n      <span class=\"token comment\">// 接受傳遞訊息 變化iframe height</span>\n      window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"message\"</span><span class=\"token punctuation\">,</span> getMessage<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">function</span> <span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>event_id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'addIframe'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>style<span class=\"token punctuation\">.</span>height <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data <span class=\"token operator\">+</span> <span class=\"token string\">'px'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token operator\">...</span></code></pre></div>\n<p>embed.html</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token operator\">...</span>\n    <span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n        document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'postWindow'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">sendMsg</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">function</span> <span class=\"token function\">sendMsg</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">var</span> height <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>scrollHeight<span class=\"token punctuation\">;</span>\n          <span class=\"token comment\">// 向parent window 送出訊息</span>\n          window<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span><span class=\"token function\">postMessage</span><span class=\"token punctuation\">(</span>\n              <span class=\"token punctuation\">{</span>\n                  <span class=\"token literal-property property\">event_id</span><span class=\"token operator\">:</span> <span class=\"token string\">'my_cors_message'</span><span class=\"token punctuation\">,</span>\n                  <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> height\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n              <span class=\"token string\">\"*\"</span> <span class=\"token comment\">// or \"www.parentpage.com\"</span>\n          <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n<span class=\"token operator\">...</span></code></pre></div>\n<p>以上就是簡單的 demo，還有更多延伸的運用，例如做出開視窗會員註冊，送出後傳遞資料回原本頁面渲染畫面。另外當你今天不得不用 iframe 的話，postMessage 會非常好用，賦予 iframe 更有彈性。另外提醒一下，實際運用要記得判斷 post Message 的網址，避免外部可能的攻擊。</p>\n<!--- ![JavaScript](../images/post_message.png \"JavaScript\") --->\n","fields":{"readingTime":{"text":"5 min read"}},"frontmatter":{"title":"HTML postMessage iframe and open window 跨視窗傳訊用法","date":"September 23, 2018","description":"當今天使用到跨視窗iframe或是openWindow，原本parent頁面需要傳遞訊息給內頁iframe或是tab頁，就可以利用postMessage來傳遞資料。接下來會建立demo頁面，介紹一下iframe跟window open的使用方法。","categories":"javascript","tags":["javascript"],"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#282828","images":{"fallback":{"src":"/static/f481421794be4d14e0e3c6cfc1eee0a7/f5128/post_message.png","srcSet":"/static/f481421794be4d14e0e3c6cfc1eee0a7/5c993/post_message.png 169w,\n/static/f481421794be4d14e0e3c6cfc1eee0a7/d57f6/post_message.png 337w,\n/static/f481421794be4d14e0e3c6cfc1eee0a7/f5128/post_message.png 674w","sizes":"(min-width: 674px) 674px, 100vw"},"sources":[{"srcSet":"/static/f481421794be4d14e0e3c6cfc1eee0a7/e97d8/post_message.webp 169w,\n/static/f481421794be4d14e0e3c6cfc1eee0a7/63408/post_message.webp 337w,\n/static/f481421794be4d14e0e3c6cfc1eee0a7/fd5a1/post_message.webp 674w","type":"image/webp","sizes":"(min-width: 674px) 674px, 100vw"}]},"width":1280,"height":647.5964391691394}}}}},"previous":{"fields":{"slug":"/2018-08-tagmanager/"},"frontmatter":{"title":"Google Tag Manager tracking code 安裝追蹤碼"}},"next":{"fields":{"slug":"/2018-09-searchconsle/"},"frontmatter":{"title":"Google Search Console教學 提交Sitemap網址、SEO工具"}}},"pageContext":{"id":"e7bf03c7-c427-580a-b032-94e06f4499fd","previousPostId":"5fa564ce-53de-50f2-9269-ebeb3c60f4c2","nextPostId":"45b8de6c-e706-5835-a288-3d07cd93a278"}},"staticQueryHashes":["3649515864","3761976949","441988385"]}